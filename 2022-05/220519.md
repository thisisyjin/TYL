# Blogrow Project

> ğŸ“ DAY 02 - 220519
- redux-saga / Axios (API ì—°ë™)
- íšŒì›ê°€ì… êµ¬í˜„
- ë¡œê·¸ì¸ êµ¬í˜„


# API ì—°ë™


## axios ì„¤ì • 

1. axiosë¥¼ ì‚¬ìš©í•˜ì—¬ API ì—°ë™

> âœ… axios
- ê°€ì¥ ë§ì´ ì‚¬ìš©ì¤‘ì¸ **HTTP í´ë¼ì´ì–¸íŠ¸.**
- HTTP ìš”ì²­ì„ **Promise ê¸°ë°˜**ìœ¼ë¡œ ì²˜ë¦¬.


2. ë¦¬ë•ìŠ¤ì—ì„œ ë¹„ë™ê¸° ì‘ì—…ì„ ì‰½ê²Œ ê´€ë¦¬í•˜ê¸° ìœ„í•´ `redux-saga`ë¥¼ ì´ìš©.


### íŒ¨í‚¤ì§€ ì„¤ì¹˜
``` bash
$ yarn add axios redux-saga
```


### axios ì¸ìŠ¤í„´ìŠ¤ ìƒì„±

- axios ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë¨¼ì € ìƒì„±í•´ì•¼ í•¨.
- `axios.create()` - [ì¸ìŠ¤í„´ìŠ¤ ìƒì„±](https://yamoo9.github.io/axios/guide/api.html#%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4-%EC%83%9D%EC%84%B1)


ğŸ”» ì˜ˆì‹œ
``` js
const instance = axios.create({
  baseURL: 'https://some-domain.com/api/', // API ì£¼ì†Œ
  headers: { 'X-Custom-Header': 'foobar' }, // í—¤ë”
  timeout: 1000, // ë¹„ë™ê¸° (setTimeout)
});
```

ì•„ë˜ì™€ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í•¨.

src/lib/api/client.js ìƒì„±

``` js
import axios from 'axios';

const client = axios.create();

/* ì˜ˆì‹œ

// API ì£¼ì†Œ ë‹¤ë¥¸ê³³ìœ¼ë¡œ ì‚¬ìš©ì‹œ
client.defaults.baseURL = 'https://external-api-server.com/'

// í—¤ë” ì„¤ì •
client.defaults.headers.common['Authorization'] = 'Bearer a1b2c3d4';

// ì¸í„°ì…‰í„° ì„¤ì •
axios.intercepter.response.use({
    respoonse => {
        return response;
    },
    error => {
        return  Promise.reject(error);
    }
})

*/

export default client;
```

- axios ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ë©´ ë‚˜ì¤‘ì— API í´ë¼ì´ì–¸íŠ¸ì— ê³µí†µëœ ì„¤ì •ì„ ì‰½ê²Œ ë„£ì–´ì¤„ ìˆ˜ ìˆìŒ.
- ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ì§€ ì•Šìœ¼ë©´ ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ ì„¤ì •í•˜ê²Œ ë˜ë¯€ë¡œ, ë‹¤ë¥¸ API ì„œë²„ ì‚¬ìš©ì‹œ ê³¤ë€í•´ì§ˆ ìˆ˜ ìˆìŒ.



***

## í”„ë¡ì‹œ ì„¤ì •

í˜„ì¬ ë°±ì—”ë“œëŠ” localhost:4000 (4000í¬íŠ¸)ì— ì—´ë ¤ìˆê³ ,
í”„ë¡ íŠ¸ì—”ë“œëŠ” localhost:3000 (3000í¬íŠ¸)ì— ì—´ë ¤ìˆê¸° ë•Œë¬¸ì—
ë³„ë„ì˜ ì„¤ì • ì—†ì´ API í˜¸ì¶œì‹œ ì˜¤ë¥˜ê°€ ë°œìƒí•¨.

> âœ… CORS(Cross Origin Request) ì˜¤ë¥˜
- ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì‹œ ì£¼ì†Œê°€ ë‹¤ë¥¸ ê²½ìš° ë°œìƒí•˜ëŠ” ì˜¤ë¥˜.
- ë‹¤ë¥¸ ì£¼ì†Œì—ì„œë„ APIë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ì„œë²„ìª½ ì½”ë“œë¥¼ ìˆ˜ì •í•´ì•¼ í•¨.

- ë¦¬ì•¡íŠ¸ í”„ë¡œì íŠ¸ì˜ ê²½ìš°ì—ëŠ” ë°°í¬ í›„ì—ëŠ” ê°™ì€ í˜¸ìŠ¤íŠ¸ì—ì„œ ì œê³µí•  ê²ƒì´ë¯€ë¡œ ì´ëŸ¬í•œ ì„¤ì •ì´ ë¶ˆí•„ìš”í•¨.
-> ëŒ€ì‹  proxy ë¼ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ê²ƒ.

> #### ğŸ”º í”„ë¡ì‹œ(proxy)ë€?
- ì›¹íŒ© ê°œë°œ ì„œë²„ì—ì„œ ì§€ì›í•˜ëŠ” ê¸°ëŠ¥.
- ê°œë°œ ì„œë²„ë¡œ ìš”ì²­í•˜ëŠ” APIë“¤ì„ ìš°ë¦¬ê°€ **í”„ë¡ì‹œë¡œ ì •í•´ë‘” ì„œë²„ë¡œ ì „ë‹¬**í•´ì£¼ê³ ,
ê·¸ **ì‘ë‹µ(response)ë¥¼ ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©** ê°€ëŠ¥í•˜ê²Œ í•´ì¤Œ.



CRA ì—ì„œ proxyë¥¼ ì„¤ì •í•´ì£¼ë ¤ë©´, `package.json`ì„ ìˆ˜ì •í•´ì¤€ë‹¤.

``` js
{
  "name": "blog-frontend",
  "version": "0.1.0",
  "private": true,
  "dependencies": {
    ...
  },
    // ğŸ”» ì¶”ê°€í•œ ê²ƒ
  "proxy": "http://localhost:4000/"
}
```

- ì´ì œ client.get('api/posts')ë¥¼ í•˜ë©´, ì›¹íŒ© ê°œë°œ ì„œë²„ê°€ í”„ë¡ì‹œ ì—­í• ì„ í•˜ì—¬
http://localhost:4000/api/postsì— **ëŒ€ì‹  ìš”ì²­**í•œ ë’¤ ì‘ë‹µí•´ì¤Œ.


### API í•¨ìˆ˜ ì‘ì„±

- íšŒì› ì¸ì¦ì— í•„ìš”í•œ APIë¥¼ ì‚¬ìš©í•˜ê¸° ì‰½ë„ë¡ í•¨ìˆ˜í™”í•˜ì—¬ íŒŒì¼ë¡œ ì‘ì„±.


src/lib/api/auth.js ìƒì„±

``` js
import client from './client';

export const login = ({ username, password }) =>
  client.post('/api/auth/login', { username, password });

export const register = ({ username, password }) =>
  client.post('/api/auth/register', { username, password });

export const check = () => client.get('/api/auth/check');

```

***

## redux-saga

### 1. loading ë¦¬ë•ìŠ¤ ëª¨ë“ˆ ìƒì„±

modules/loading.js ìƒì„±
``` js
import { createAction, handleActions } from 'redux-actions';

const START_LOADING = 'loading/START_LOADING';
const FINISH_LOADING = 'loading/FINISH_LOADING';

export const startLoading = createAction(
  START_LOADING,
  (requestType) => requestType,
);

export const finishLoading = createAction(
  FINISH_LOADING,
  (requestType) => requestType,
);

const initialState = {};

const loading = handleActions(
  {
    [START_LOADING]: (state, action) => ({
      ...state,
      [action.payload]: true,
    }),
    [FINISH_LOADING]: (state, action) => ({
      ...state,
      [action.payload]: false,
    }),
  },
  initialState,
);

export default loading;

```


### 2. ë£¨íŠ¸ ë¦¬ë“€ì„œì— ë“±ë¡

modules/index.js ìˆ˜ì •

``` js
import { combineReducers } from 'redux';
import auth from './auth';
import loading from './loading';

const rootReducer = combineReducers({
  auth,
  loading,
});

export default rootReducer;

```
### 3. createRequestSaga í•¨ìˆ˜ 

> ğŸ“Œ **redux-saga**ëŠ” ì œë„¤ë ˆì´í„° í•¨ìˆ˜ (`function*()`)ë¥¼ ì´ìš©í•œ ë¦¬ë•ìŠ¤ ë¯¸ë“¤ì›¨ì–´ì´ë‹¤.
-> ìì„¸í•œ ë‚´ìš©ì€ [ê³µì‹ ë¬¸ì„œ](https://redux-saga.js.org/docs/introduction/GettingStarted)ì™€ [ì°¸ì¡° ë¬¸ì„œ](https://redux-advanced.vlpt.us/2/05.html)ë¥¼ ì°¸ì¡°!
- ì°¸ê³ ) **ìŠ¤í† ì–´ì— ë¯¸ë“¤ì›¨ì–´ ì ìš©**ì‹œ  createStoreì˜ ë‘ë²ˆì§¸ ì¸ìë¡œ applyMiddlewareë¥¼ ë„£ì–´ì¤Œ
``` js
const store = createStore(modules, applyMiddleware(logger, sagaMiddleware));
```

src/lib/createRequestSaga.js

``` js
import { call, put } from 'redux-saga/effects';
import { startLoading, finishLoading } from '../modules/loading';

// call = ì²«ì¸ìì— ë‘ë²ˆì§¸ ì¸ìë¥¼ ì „ë‹¬í•˜ì—¬ í˜¸ì¶œí•¨
// put = ìƒˆ ì•¡ì…˜ì„ ë””ìŠ¤íŒ¨ì¹˜ -> ì•¡ì…˜ìƒì„±í•¨ìˆ˜(Payload)
export default function createRequestSaga(type, request) {
  // typeì€ ìš”ì²­ ì„±ê³µ or ì‹¤íŒ¨ ì—¬ë¶€.
  // requestëŠ” í•¨ìˆ˜í˜•íƒœ. (ì—¬ê¸°ì— API ìš”ì²­ - axios.getì´ ë“¤ì–´ê°ˆë“¯)
  const SUCCESS = `${type}_SUCCESS`;
  const FAILURE = `${type}_FAILURE`;

  return function* (action) {
    yield put(startLoading(type)); // ë¡œë”© ì‹œì‘
    try {
      const response = yield call(request, action.payload);
      yield put({
        type: SUCCESS,
        payload: response.data,
      });
    } catch (e) {
      yield put({
        type: FAILURE,
        payload: e,
        error: true,
      });
    }
    yield put(finishLoading(type));
  };
}
```

> ğŸ”º **yield** ë’¤ì— ì˜¤ëŠ” í•¨ìˆ˜ë“¤ - **call, put, delay**
`call`: ì²«ë²ˆì§¸ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•œ í•¨ìˆ˜ì— ê·¸ ë’¤ì— ìˆëŠ” íŒŒë¼ë¯¸í„°ë“¤ì€ ì „ë‹¬í•˜ì—¬ í˜¸ì¶œ
`put`: ìƒˆ ì•¡ì…˜ì„ dispatch í•¨.
`delay`: ms ë‹¨ìœ„ë¡œ ëŒ€ê¸°
+) ê·¸ ì™¸ì—ë„ takeEvery, takeLastest ë“±ì´ ìˆìŒ


### 4. auth ë¦¬ë•ìŠ¤ ëª¨ë“ˆì—ì„œ API ì‚¬ìš©
- ë°©ê¸ˆ ë§Œë“  createRequestSaga í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ auth ëª¨ë“ˆì—ì„œ APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ êµ¬í˜„.
- ìš°ì„  ì´ 6ê°œì˜ ì•¡ì…˜ íƒ€ì…ì„ ì¶”ê°€ë¡œ ë” ì„ ì–¸í•´ì•¼ í•¨. 
(ê¸°ì¡´ì— ìˆë˜ CHANGE_FIELD, INITIALIZE_FORMì—ì„œ ì¶”ê°€í•¨)

1. REGISTER
2. REGISTER_SUCCESS
3. REGISTER_FAILURE


4. LOGIN
5. LOGIN_SUCCESS
6. LOGIN_FAILURE

-> 6ê°œë¥¼ ì„ ì–¸í•´ì•¼ í•˜ë¯€ë¡œ, ê°™ì€ ì‘ì—…ì´ ë°˜ë³µë¨.
createRequestActionTypes ë¼ëŠ” í•¨ìˆ˜ë¥¼ ì„ ì–¸í•˜ì—¬ ë¦¬íŒ©í† ë§.

#### âš¡ï¸ createRequestActionTypes í•¨ìˆ˜

createRequestSaga.js ìˆ˜ì •
``` js
export const createRequestActionTypes = (type) => {
  const SUCCESS = `${type}_SUCCESS`;
  const FAILURE = `${type}_FAILURE`;
  return [type, SUCCESS, FAILURE];
};

...
```
<br>

#### auth.js ìˆ˜ì •

``` js
import { createRequestActionTypes } from '../lib/createRequestSaga';

...

const [REGISETR, REGISETR_SUCCESS, REGISETR_FAILURE] = createRequestActionTypes('auth/REGISTER');
const [LOGIN, LOGIN_SUCCESS, LOGIN_FAILURE] = createRequestActionTypes('auth/LOGIN');
```

- ë°°ì—´ êµ¬ì¡°ë¶„í•´ í• ë‹¹ì„ ì‚¬ìš©í•˜ì—¬ ê°„ë‹¨í•˜ê²Œ ì½”ë“œë¥¼ ì •ë¦¬í•¨.

<br>

### 5. APIë¥¼ ìœ„í•œ ì‚¬ê°€ ìƒì„±
-> sagaë€, ì œë„ˆë ˆì´í„° í•¨ìˆ˜ë¥¼ ì˜ë¯¸í•¨.
-> `createRequestSaga()` í•¨ìˆ˜ê°€ `return function*()`ì„ í•˜ë¯€ë¡œ, ì‚¬ê°€ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì„.


modules/auth.js ìˆ˜ì •

``` js
import { createAction, handleActions } from 'redux-actions';
import produce from 'immer';
import { takeLatest } from 'redux-saga/effects';
import createRequestSaga, {
  createRequestActionTypes,
} from '../lib/createRequestSaga';
import * as authAPI from '../lib/api/auth';

const CHANGE_FIELD = 'auth/CHANGE_FIELD';
const INITIALIZE_FORM = 'auth/INITIALIZE_FORM';

const [REGISTER, REGISTER_SUCCESS, REGISTER_FAILURE] =
  createRequestActionTypes('auth/REGISTER');
const [LOGIN, LOGIN_SUCCESS, LOGIN_FAILURE] =
  createRequestActionTypes('auth/LOGIN');

export const changeField = createAction(
  CHANGE_FIELD,
  ({ form, key, value }) => ({ form, key, value }),
  // form: register, login / key: username, password, passwordConfirm
);
export const initializeForm = createAction(INITIALIZE_FORM, (form) => form);
// register, login

export const register = createAction(REGISTER, ({ username, password }) => ({
  username,
  password,
}));

export const login = createAction(LOGIN, ({ username, password }) => ({
  username,
  password,
}));

// ğŸ”» saga ìƒì„±

// ì²«ë²ˆì§¸ ì¸ì = type (REGISTER/LOGIN) , ë‘ë²ˆì§¸ ì¸ì = request (ì•¡ì…˜ìƒì„±í•¨ìˆ˜)
const registerSaga = createRequestSaga(REGISTER, authAPI.register);
const loginSaga = createRequestSaga(LOGIN, authAPI.login);
export function* authSaga() {
  yield takeLatest(REGISTER, registerSaga);
  yield takeLatest(LOGIN, loginSaga);
}

const initialState = {
  register: {
    username: '',
    password: '',
    passwordConfirm: '',
  },
  login: {
    username: '',
    password: '',
  },
  auth: null,
  authError: null,
};

const auth = handleActions(
  {
    [CHANGE_FIELD]: (state, { payload: { form, key, value } }) =>
      produce(state, (draft) => {
        draft[form][key] = value; // ex> state.register.username
      }),
    [INITIALIZE_FORM]: (state, { payload: form }) => ({
      ...state,
      [form]: initialState[form],
      authError: null,
    }),
    [REGISTER_SUCCESS]: (state, { payload: auth }) => ({
      ...state,
      authError: null,
      auth, // auth: auth
    }),
    [REGISTER_FAILURE]: (state, { payload: error }) => ({
      ...state,
      authError: error,
    }),
    [LOGIN_SUCCESS]: (state, { payload: auth }) => ({
      ...state,
      authError: null,
      auth,
    }),
    [LOGIN_FAILURE]: (state, { payload: error }) => ({
      ...state,
      authError: error,
    }),
  },

  initialState,
);

export default auth;
```

> #### ğŸ”º redux-sagaì˜ `takeLatests` í•¨ìˆ˜
ê¸°ì¡´ì— ì§„í–‰ ì¤‘ì´ë˜ ì‘ì—…ì´ ìˆë‹¤ë©´ **ì·¨ì†Œ ì²˜ë¦¬**í•˜ê³  **ê°€ì¥ ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹¤í–‰ëœ ì‘ì—…**ë§Œ ìˆ˜í–‰.
ì˜ˆ>`takeLatest(DECREASE_ASYNC, decreaseSaga)`
â†’ `DECREASE_ASYNC` ì•¡ì…˜ì— ëŒ€í•´ì„œ ê¸°ì¡´ì— ì§„í–‰ ì¤‘ì´ë˜ ì‘ì—…ì´ ìˆë‹¤ë©´ ì·¨ì†Œ ì²˜ë¦¬í•˜ê³  
ê°€ì¥ ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹¤í–‰ëœ ì‘ì—…ì— ëŒ€í•´ì„œë§Œ `decreaseSaga()`í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•œë‹¤.

<br>

### 5. rootSaga ìƒì„±

rootReducerê³¼ ë§ˆì°¬ê°€ì§€ë¡œ modules/index.js ì— ìƒì„±.

``` jsx
import { combineReducers } from 'redux';
import { all } from 'redux-saga/effects';
import auth, { authSaga } from './auth';
import loading from './loading';

const rootReducer = combineReducers({
  auth,
  loading,
});

// ğŸ”» all()í•¨ìˆ˜ì˜ ì¸ì = í•¨ìˆ˜ê°’ ë°°ì—´ì„ ë„£ì–´ì¤Œ.
export function* rootSaga() {
  yield all([authSaga()]);
}

export default rootReducer;

```

`combineReducers()`ì˜ ê²½ìš°ì—ëŠ” ë¦¬ë“€ì„œí•¨ìˆ˜(auth, loading) ìì²´ë¥¼ ë‹´ì€ **ê°ì²´**ë¥¼ ì¸ìë¡œ ë„£ì–´ì¤¬ë‹¤.

ë°˜ë©´ì— `all()` í•¨ìˆ˜ì˜ ì¸ìë¡œëŠ” ì‚¬ê°€ë¥¼ í˜¸ì¶œí•œ í›„(=ê²°ê³¼ê°’) **ë°°ì—´**ì— ë‹´ì•„ ì¸ìë¡œ ë„£ì–´ì¤€ë‹¤.




### 6. storeì— ë¯¸ë“¤ì›¨ì–´ ì ìš©

src/index.js

``` jsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import { BrowserRouter } from 'react-router-dom';
import './index.css';
import { Provider } from 'react-redux';
import { createStore, applyMiddleware } from 'redux';
import { composeWithDevTools } from 'redux-devtools-extension';
import createSagaMiddleware from 'redux-saga';
import rootReducer, { rootSaga } from './modules';


// ğŸ”» 1. sagaMiddleware ìƒì„±
const sagaMiddleware = createSagaMiddleware();
// ğŸ”» 2. ë‘ë²ˆì§¸ ì¸ìì— applyMiddleware(sagaMiddleware) ë„£ì–´ì¤Œ 
const store = createStore(
  rootReducer,
  composeWithDevTools(applyMiddleware(sagaMiddleware)),
);

// ğŸ”» 3. sagaMiddleware.run(rootSaga) ë¡œ ì‹¤í–‰
sagaMiddleware.run(rootSaga);

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <Provider store={store}>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </Provider>,
);

```
> #### ğŸ›  ë¯¸ë“¤ì›¨ì–´ ì ìš© ê³¼ì •
1. const sagaMiddleware = createSagaMiddleware();
2. const store = createStore(rootReducer, composeWithDevTools(applyMiddleware(sagaMiddleware))
3. sagaMiddleware.run(rootSaga)


***

ì´ì œ ë¦¬ë•ìŠ¤ ê´€ë ¨ ì½”ë“œëŠ” ëª¨ë‘ ë!
íšŒì›ê°€ì… ê¸°ëŠ¥ êµ¬í˜„ + ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„ í•„ìš”.

***

## íšŒì›ê°€ì… êµ¬í˜„

containers/auth/RegisterForm.js ìˆ˜ì •

``` jsx
import { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { changeField, initializeForm, register } from '../../modules/auth';
import AuthForm from '../../components/auth/AuthForm';

const RegisterForm = () => {
  const dispatch = useDispatch();
  const { form, auth, authError } = useSelector(({ auth }) => ({
    // auth ëª¨ë“ˆì˜ stateë¥¼ ë¶ˆëŸ¬ì˜´
    form: auth.register,
    auth: auth.auth,
    authError: auth.authError,
  }));

  const onChange = (e) => {
    const { value, name } = e.target;
    dispatch(
      changeField({
        form: 'register',
        key: name,
        value, // value: e.target.value
      }),
    );
  };

  // ğŸ”» í¼ ì œì¶œì‹œ - passwordì™€ passwordConfirmì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸ í›„ register ì•¡ì…˜ ë””ìŠ¤íŒ¨ì¹˜
  const onSubmit = (e) => {
    e.preventDefault();
    const { username, password, passwordConfirm } = form;
    if (password !== passwordConfirm) {
      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë¶ˆì¼ì¹˜ - ì—ëŸ¬ì²˜ë¦¬
      return;
    }
    // ğŸ”» 
    dispatch(register({ username, password }));
  };

  useEffect(() => {
    dispatch(initializeForm('register'));
  }, [dispatch]);

  // ğŸ”» íšŒì›ê°€ì… ì‹¤íŒ¨ / ì„±ê³µ ì²˜ë¦¬. 
  useEffect(() => {
    if (authError) {
      console.log('ì˜¤ë¥˜ ë°œìƒ');
      console.log(authError);
      return;
    }
    if (auth) {
      console.log('íšŒì›ê°€ì… ì„±ê³µ');
      console.log(auth);
    }
  }, [auth, authError]);

  return (
    <AuthForm
      type="register"
      form={form}
      onChange={onChange}
      onSubmit={onSubmit}
    />
  );
};

export default RegisterForm;

```

***

### TEST

- íšŒì›ê°€ì… êµ¬í˜„ì´ ì˜ ë˜ì—ˆëŠ”ì§€ í…ŒìŠ¤íŠ¸.
- ìš°ì„  ì„œë²„ë„ `yarn start:dev`ë¡œ ì‹¤í–‰ì‹œì¼œì£¼ê³ ,
frontendë„ `yarn start`ë¡œ ì‹¤í–‰ì‹œì¼œì¤˜ì•¼ í•¨.

![](https://velog.velcdn.com/images/thisisyjin/post/29cae178-bcd7-4f25-94cb-9b80fc523c74/image.png)


íšŒì›ê°€ì… ì„±ê³µì´ë¼ê³  ëœ¸.

ë§Œì•½ íšŒì›ê°€ì… ë²„íŠ¼ì„ í•œë²ˆ ë” ëˆ„ë¥´ë©´?
![](https://velog.velcdn.com/images/thisisyjin/post/1a2b6338-0769-4ec3-a6dc-654beed3689c/image.png)
-> ì´ì „ì— ë°±ì—”ë“œì—ì„œ ì‘ì„±í–ˆë˜ ë¡œì§ì— ì˜í•´ 409(Conflict) ì—ëŸ¬ê°€ ë°œìƒí•¨.


- ë°±ì—”ë“œ ë¡œì§ ë‹¤ì‹œë³´ê¸°

src/api/auth/auth.ctrl.js

``` js
// 1. íšŒì› ê°€ì… (ë“±ë¡)
export const register = async (ctx) => {
  // request body ê²€ì¦
  const schema = Joi.object().keys({
    username: Joi.string().alphanum().min(3).max(20).required(),
    password: Joi.string().required(),
  });

  const result = schema.validate(ctx.request.body);

  if (result.error) {
    ctx.status = 400;
    ctx.body = result.error;
    return;
  }

  const { username, password } = ctx.request.body;
  try {
    // username ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ ì²´í¬
    const exists = await User.findByUsername(username);
    if (exists) {
      ctx.status = 409; // conflict
      return;
    }

    const user = new User({
      username,
    });
    await user.setPassword(password);
    await user.save(); // DBì— ì €ì¥

    ctx.body = user.serialize();
    const token = user.generateToken();
    ctx.cookies.set('access_token', token, {
      maxAge: 1000 * 60 * 60 * 24 * 7, // 7d
      httpOnly: true,
    });
  } catch (e) {
    ctx.throw(500, e);
  }
};
```

### mongoDB í™•ì¸
mongoDB Compassì—ì„œ blog DBì— users ì»¬ë ‰ì…˜ì„ ì‚´í´ë³´ì.

![](https://velog.velcdn.com/images/thisisyjin/post/75e3de5c-bf08-4dc2-8781-7442cf3aa7a1/image.png)

-> ë§¨ ì•„ë˜ì— ë°©ê¸ˆ ê°€ì…ì„ ëˆ„ë¥¸ ìœ ì € ì •ë³´ê°€ ë³´ì¸ë‹¤! dbì—ë„ ì˜ ë“±ë¡ëœ ê²ƒ.


<br>

### user ëª¨ë“ˆ ìƒì„±

- ì‚¬ìš©ìì˜ ìƒíƒœë¥¼ ë‹´ì„ users ëª¨ë¸ì„ ìƒì„±.
- ìƒˆë¡œê³ ì¹¨ ì´í›„ ì„ì‹œ ë¡œê·¸ì¸ ì²˜ë¦¬ë¥¼ í•´ì£¼ê¸° ìœ„í•¨. (TEMP_SET_USER ì•¡ì…˜)
- takeLatest / ì‚¬ê°€ ìƒì„± (createRequestSaga ëª¨ë“ˆ ì‚¬ìš©)


``` js
import { createAction, handleActions } from 'redux-actions';
import { takeLatests } from 'redux-saga/effects';
import * as authAPI from '../lib/api/auth';
import createRequestSaga, {
  createRequestActionTypes,
} from '../lib/createRequestSaga';

const TEMP_SET_USER = 'user/TEMP_SET_USER';
const [CHECK, CHECK_SUCCESS, CHECK_FAILURE] =
  createRequestActionTypes('user/CHECK');

export const tempSetUser = createAction(TEMP_SET_USER, (user) => user);
export const check = createAction(CHECK);

// saga ìƒì„±
const checkSaga = createRequestSaga(CHECK, authAPI.check); //  client.get('/api/auth/check')
export function* userSaga() {
  yield takeLatests(CHECK, checkSaga);
} // userSagaë¥¼ rootSagaë¡œ í•©ì³ì¤Œ

const initialState = {
  user: null,
  checkError: null,
};

export default handleActions(
  {
    [TEMP_SET_USER]: (state, { payload: user }) => ({
      ...state,
      user,
    }),
    [CHECK_SUCCESS]: (state, { payload: user }) => ({
      ...state,
      user,
      checkError: null,
    }),
    [CHECK_FAILURE]: (state, { payload: error }) => ({
      ...state,
      user: null,
      checkError: error,
    }),
  },
  initialState,
);
```


### ë£¨íŠ¸ ë¦¬ë“€ì„œ + ë£¨íŠ¸ ì‚¬ê°€ì— í¬í•¨

modules/index.js
``` js
import { combineReducers } from 'redux';
import { all } from 'redux-saga/effects';
import auth, { authSaga } from './auth';
import loading from './loading';
import user, { userSaga } from './user';

const rootReducer = combineReducers({
  auth,
  loading,
  user,
});

export function* rootSaga() {
  yield all([authSaga(), userSaga()]);
}

export default rootReducer;
```

***


### RegisterForm ìˆ˜ì •
- íšŒì›ê°€ì… ì„±ê³µ í›„, check ëª¨ë“ˆì„ í˜¸ì¶œí•˜ì—¬ ë¡œê·¸ì¸ ìƒíƒœì¸ì§€ í™•ì¸.


containers/auth/RegisterForm.js ìˆ˜ì •
``` js
import { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { changeField, initializeForm, register } from '../../modules/auth';
import AuthForm from '../../components/auth/AuthForm';
import { check } from '../../modules/user';

const RegisterForm = () => {
  const dispatch = useDispatch();
  const { form, auth, authError, user } = useSelector(({ auth, user }) => ({
    // auth ëª¨ë“ˆì˜ stateë¥¼ ë¶ˆëŸ¬ì˜´
    form: auth.register,
    auth: auth.auth,
    authError: auth.authError,
    // ğŸ”» user ëª¨ë“ˆì˜ stateë¥¼ ë¶ˆëŸ¬ì˜´ (state.user.user)
    user: user.user,
  }));

  const onChange = (e) => {
    const { value, name } = e.target;
    dispatch(
      changeField({
        form: 'register',
        key: name,
        value, // value: e.target.value
      }),
    );
  };

  const onSubmit = (e) => {
    e.preventDefault();
    const { username, password, passwordConfirm } = form;
    if (password !== passwordConfirm) {
      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë¶ˆì¼ì¹˜ - ì—ëŸ¬ì²˜ë¦¬
      return;
    }
    dispatch(register({ username, password }));
  };

  useEffect(() => {
    dispatch(initializeForm('register'));
  }, [dispatch]);

  // íšŒì›ê°€ì… ì‹¤íŒ¨/ì„±ê³µ ì²˜ë¦¬
  useEffect(() => {
    if (authError) {
      console.log('ì˜¤ë¥˜ ë°œìƒ');
      console.log(authError);
      return;
    }
    if (auth) {
      console.log('íšŒì›ê°€ì… ì„±ê³µ');
      console.log(auth);
      // ğŸ”» check (ì•¡ì…˜ ìƒì„±í•¨ìˆ˜)ë¥¼ dispatch (payloadëŠ” ì—†ìŒ)
      dispatch(check());
    }
  }, [auth, authError, dispatch]);

  // ğŸ”» user ê°’ì´ ì˜ ì„¤ì •ë˜ì—ˆë‚˜ ì²´í¬
  useEffect(() => {
    if (user) {
      console.log('check API ì„±ê³µ');
      console.log(user);
    }
  }, [user]);

  return (
    <AuthForm
      type="register"
      form={form}
      onChange={onChange}
      onSubmit={onSubmit}
    />
  );
};

export default RegisterForm;

```


redux devToolì„ ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ user ì•ˆì— ê°’ì´ ë“¤ì–´ê°€ ìˆë‹¤ë©´ ì„±ê³µ!
![](https://velog.velcdn.com/images/thisisyjin/post/be00919c-ec65-4867-94e2-5016058d70af/image.png)



### íšŒì›ê°€ì… ì„±ê³µì‹œ í™ˆ(/)ìœ¼ë¡œ ì´ë™

- ë¼ìš°íŠ¸ë¥¼ ì´ë™ì‹œí‚¤ë©´ ë¨.
- history ê°ì²´ë¥¼ ì‚¬ìš©. 
-> `withRouter`ë¡œ ì»´í¬ë„ŒíŠ¸ë¥¼ ê°ì‹¸ì£¼ë©´ ë¨.


- **react-router-dom**ì˜ `useNavigate()` í•¨ìˆ˜ë¥¼ ì´ìš©í•¨.


containers/auth/RegisterForm.js ìˆ˜ì •
``` js
import { useNavigate } from 'react-router-dom';

const navigate = useNavigate();

useEffect(() => {
  if (user) {
    // user ê°’ì´ ìˆìœ¼ë©´? -> íšŒì›ê°€ì… ì„±ê³µ -> í™ˆìœ¼ë¡œ ì´ë™ì‹œì¼œì•¼í•¨
    navigate('/'); // í™ˆìœ¼ë¡œ ì´ë™
  }
}, [navigate, user]);

```
- íšŒì›ê°€ì… ì„±ê³µ ì‹œ / ê²½ë¡œë¡œ ì´ë™í•˜ê²Œ ë¨.

<br>

***

## ë¡œê·¸ì¸ êµ¬í˜„

containers/auth/LoginForm.js ìˆ˜ì •
``` js
import { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { changeField, initializeForm, login } from '../../modules/auth';
import AuthForm from '../../components/auth/AuthForm';
import { check } from '../../modules/user';
import { useNavigate } from 'react-router-dom';

const LoginForm = () => {
  const dispatch = useDispatch();
  const { form, auth, authError, user } = useSelector(({ auth, user }) => ({
    form: auth.login, // { username, password}
    auth: auth.auth,
    authError: auth.authError,
    user: user.user,
  }));

  const onChange = (e) => {
    const { value, name } = e.target;
    dispatch(
      changeField({
        form: 'login',
        key: name,
        value, // value: e.target.value
      }),
    );
  };

  const onSubmit = (e) => {
    e.preventDefault();
    const { username, password } = form;
    // LOGIN ì•¡ì…˜ ë””ìŠ¤íŒ¨ì¹˜
    dispatch(login({ username, password }));
  };

  useEffect(() => {
    dispatch(initializeForm('login'));
  }, [dispatch]);

  // ë¡œê·¸ì¸ ì‹¤íŒ¨, ì„±ê³µ ì—¬ë¶€
  useEffect(() => {
    if (authError) {
      console.log('ì˜¤ë¥˜ ë°œìƒ');
      console.log(authError);
    }
    if (auth) {
      console.log('ë¡œê·¸ì¸ ì„±ê³µ');
      console.log(auth);
      // check
      dispatch(check()); // CHECK ì•¡ì…˜ ë””ìŠ¤íŒ¨ì¹˜
    }
  }, [auth, authError, dispatch]);

  // ë¡œê·¸ì¸ ì„±ê³µì‹œ -> í™ˆìœ¼ë¡œ ì´ë™
  const navigate = useNavigate();
  useEffect(() => {
    if (user) {
      navigate('/');
    }
  }, [navigate, user]);

  return (
    <AuthForm
      type="login"
      form={form}
      onChange={onChange}
      onSubmit={onSubmit}
    />
  );
};

export default LoginForm;

```

- check ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜´ (user.js)
- useEffectë¡œ ë¡œê·¸ì¸ ì‹¤íŒ¨/ì„±ê³µ ì—¬ë¶€ ë‚˜íƒ€ëƒ„. (user ê°’ì´ ì¡´ì¬í•˜ëŠ”ì§€)
- useNavigate ë¥¼ ì´ìš©. (ë¡œê·¸ì¸ ì„±ê³µì‹œ / ê²½ë¡œë¡œ ì´ë™)


***

## íšŒì› ì¸ì¦ ì—ëŸ¬ ì²˜ë¦¬

- ë¡œê·¸ì¸ / íšŒì›ê°€ì…ì‹œ ë°œìƒí•˜ëŠ” ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•´ì¤Œ.

>ğŸ” 1. ë¡œê·¸ì¸ì‹œ
-> ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜ì‹œ ì—ëŸ¬


### Login component ìˆ˜ì •

- ì—ëŸ¬ ë°œìƒì‹œ ì—ëŸ¬ ë©”ì‹œì§€ UI ë Œë”ë§
- ë°ì´í„°ëŠ” propsë¡œ ì „ë‹¬ë°›ìŒ. (error ì—¬ë¶€)

components/auth/AuthForm.js ìˆ˜ì •

``` jsx
import styled from 'styled-components';
import palette from '../../lib/styles/palette';
import { Link } from 'react-router-dom';
import Button from '../common/Button';

...

const ErrorMessage = styled.div`
  color: #ff0000;
  text-align: center;
  font-size: 0.85rem;
  margin-top: 1rem;
`;

const AuthForm = ({ type, form, onChange, onSubmit, error }) => {
  const text = textMap[type];
  return (
    <AuthFormBlock>
      <h3>{text}</h3>
      <form onSubmit={onSubmit}>
        <StyledInput
          autoComplete="username"
          name="username"
          placeholder="ì•„ì´ë””"
          onChange={onChange}
          value={form.username}
        />
        <StyledInput
          type="password"
          autoComplete="new-password"
          name="password"
          placeholder="ë¹„ë°€ë²ˆí˜¸"
          onChange={onChange}
          value={form.password}
        />
        {type === 'register' && (
          <StyledInput
            autoComplete="new-password"
            name="passwordConfirm"
            placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
            type="password"
            onChange={onChange}
            value={form.passwordConfirm}
          />
        )}
        // ğŸ”» errorì´ trueì¼ë•Œë§Œ ErrorMessageë¥¼ ë„ì›€.
        {error && <ErrorMessage>ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</ErrorMessage>}
        <ButtonWithMarginTop teal fullWidth>
          {text}
        </ButtonWithMarginTop>
      </form>
      <Footer>
        {type === 'login' ? (
          <Link to="/register">íšŒì›ê°€ì…</Link>
        ) : (
          <Link to="/login">ë¡œê·¸ì¸</Link>
        )}
      </Footer>
    </AuthFormBlock>
  );
};

export default AuthForm;

```

![](https://velog.velcdn.com/images/thisisyjin/post/3f41ca83-fbb6-4971-b28d-002f369f346c/image.png)

### Login container ìˆ˜ì •

- AuthForm ì—ê²Œ errorì´ë¼ëŠ” propsë¥¼ ì „ë‹¬í•´ì¤Œ.
- useStateë¡œ 'error'ë¼ëŠ” ìƒíƒœ ì¶”ê°€í•¨.


containers/auth/LoginForm
-> ì»¨í…Œì´ë„ˆì—ì„œ ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ í›¨ì”¬ ì‰¬ì›€.

``` jsx
import { useEffect, useState } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { changeField, initializeForm, login } from '../../modules/auth';
import AuthForm from '../../components/auth/AuthForm';
import { check } from '../../modules/user';
import { useNavigate } from 'react-router-dom';

const LoginForm = () => {
  // ğŸ”» state ì¶”ê°€ 
  const [error, setError] = useState(false);
	
 		 ...

  // ë¡œê·¸ì¸ ì‹¤íŒ¨, ì„±ê³µ ì—¬ë¶€
  useEffect(() => {
    if (authError) {
      console.log('ì˜¤ë¥˜ ë°œìƒ');
      console.log(authError);
      setError(true);
    }
    if (auth) {
      console.log('ë¡œê·¸ì¸ ì„±ê³µ');
      console.log(auth);
      // check
      dispatch(check()); // CHECK ì•¡ì…˜ ë””ìŠ¤íŒ¨ì¹˜
    }
  }, [auth, authError, dispatch]);

  return (
    <AuthForm
      type="login"
      form={form}
      onChange={onChange}
      onSubmit={onSubmit}
      error={error}
    />
  );
};

export default LoginForm;

```

- ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì‹œ ErrorMessage ê°€ ë Œë”ë§.
![](https://velog.velcdn.com/images/thisisyjin/post/a0e8bbff-b40f-4c59-b2b1-47a12f26d661/image.png)


<center>* * *</center>


>ğŸ‘¥ 2. íšŒì›ê°€ì…ì‹œ
-> ì…ë ¥ì°½ì´ ë¹„ì–´ìˆì„ ë•Œ / passwordì™€ passwordConfirmì´ ì¼ì¹˜í•˜ì§€ ì•Šì„ ë•Œ / usernameì´ ì¤‘ë³µë  ë•Œ ì—ëŸ¬

### Register container ìˆ˜ì •

containers/auth/RegisterForm.js ìˆ˜ì •
``` jsx
import { useEffect, useState } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { changeField, initializeForm, register } from '../../modules/auth';
import AuthForm from '../../components/auth/AuthForm';
import { check } from '../../modules/user';
import { useNavigate } from 'react-router-dom';

const RegisterForm = () => {
  const [error, setError] = useState(null);

  const dispatch = useDispatch();
  const { form, auth, authError, user } = useSelector(({ auth, user }) => ({
    // auth ëª¨ë“ˆì˜ stateë¥¼ ë¶ˆëŸ¬ì˜´
    form: auth.register,
    auth: auth.auth,
    authError: auth.authError,
    // user ëª¨ë“ˆì˜ stateë¥¼ ë¶ˆëŸ¬ì˜´
    user: user.user,
  }));

  const onChange = (e) => {
    const { value, name } = e.target;
    dispatch(
      changeField({
        form: 'register',
        key: name,
        value, // value: e.target.value
      }),
    );
  };

  const onSubmit = (e) => {
    e.preventDefault();
    const { username, password, passwordConfirm } = form;
    // ì¸í’‹ í•˜ë‚˜ë¼ë„ ë¹„ì–´ìˆìœ¼ë©´
    if ([username, password, passwordConfirm].includes('')) {
      setError('ë¹ˆ ì¹¸ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }
    if (password !== passwordConfirm) {
      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë¶ˆì¼ì¹˜ì‹œ
      setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      dispatch(changeField({ form: 'register', key: 'password', value: '' })); // password ì¸í’‹ì„ ë¹ˆì¹¸ìœ¼ë¡œ ë§Œë“¬
      dispatch(
        changeField({ form: 'register', key: 'passwordConfirm', value: '' }),
      );
      return;
    }
    dispatch(register({ username, password })); // REGISTER ì•¡ì…˜ ë””ìŠ¤íŒ¨ì¹˜
  };

  useEffect(() => {
    dispatch(initializeForm('register'));
  }, [dispatch]);

  // íšŒì›ê°€ì… ì‹¤íŒ¨/ì„±ê³µ ì²˜ë¦¬
  useEffect(() => {
    if (authError) {
      // ê³„ì •ëª…ì´ ì´ë¯¸ ì¡´ì¬í•  ë•Œ - 409 Conflict
      if (authError.response.status === 409) {
        setError('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê³„ì •ëª…ì…ë‹ˆë‹¤.');
        return;
      }
      // ê·¸ ì™¸ ì´ìœ 
      setError('íšŒì›ê°€ì… ì‹¤íŒ¨');
      return;
    }
    if (auth) {
      console.log('íšŒì›ê°€ì… ì„±ê³µ');
      console.log(auth);
      dispatch(check());
    }
  }, [auth, authError, dispatch]);

  // user ê°’ì´ ì˜ ì„¤ì •ë˜ì—ˆë‚˜ ì²´í¬
  useEffect(() => {
    if (user) {
      console.log('check API ì„±ê³µ');
      console.log(user);
    }
  }, [user]);

  const navigate = useNavigate();
  useEffect(() => {
    if (user) {
      // user ê°’ì´ ìˆìœ¼ë©´? -> íšŒì›ê°€ì… ì„±ê³µ -> í™ˆìœ¼ë¡œ ì´ë™ì‹œì¼œì•¼í•¨
      navigate('/'); // í™ˆìœ¼ë¡œ ì´ë™
    }
  }, [navigate, user]);

  return (
    <AuthForm
      type="register"
      form={form}
      onChange={onChange}
      onSubmit={onSubmit}
      error={error}
    />
  );
};

export default RegisterForm;
```


### Register components ìˆ˜ì •

components/auth/AuthForm.js
``` jsx
{error && <ErrorMessage>{error}</ErrorMessage>}
```
error ë¬¸êµ¬ê°€ ë‹¬ë¼ì ¸ì•¼ í•˜ë¯€ë¡œ ìœ„ì™€ ê°™ì´ ë³€ê²½í•¨.



![](https://velog.velcdn.com/images/thisisyjin/post/e18edbb7-bb1a-4acf-b480-e84aa24aa407/image.png) -> í•˜ë‚˜ë¼ë„ ë¹ˆì¹¸ì´ ìˆì„ ê²½ìš°

<br>

![](https://velog.velcdn.com/images/thisisyjin/post/e1a8ce80-f197-4e04-a97c-f6c56d8033cf/image.png) -> password, passwordConfirm ì¹¸ì´ ë¹„ì›Œì§
``` js
dispatch(changeField({ form: 'register', key: 'password', value: '' })); // password ì¸í’‹ì„ ë¹ˆì¹¸ìœ¼ë¡œ ë§Œë“¬
dispatch(
        changeField({ form: 'register', key: 'passwordConfirm', value: '' }),
      );
```
changeField ì•¡ì…˜ì„ ì‹¤í–‰ì‹œì¼œ valueë¥¼ ''ë¡œ ë§Œë“¤ì–´ë²„ë ¸ê¸° ë•Œë¬¸.


<br>

![](https://velog.velcdn.com/images/thisisyjin/post/ff77ed6f-c2be-43b6-8f4e-c8b94896d23e/image.png) -> ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê³„ì •ëª…ì¸ ê²½ìš°


