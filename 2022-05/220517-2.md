# React.js

**Today I Learned ... **`react.js`

>ğŸ™‹â€â™‚ï¸ [**Reference Book**](https://nomadcoders.co/react-hooks-introduction)

>ğŸ™‹â€ [**My Dev Blog**](https://mywebproject.tistory.com/)

***

> ** CH 23. JWTë¥¼ í†µí•œ íšŒì› ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ **
- posts APIì— íšŒì›ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„
- username, tagë¡œ í¬ìŠ¤íŠ¸ í•„í„°ë§


## posts API - íšŒì›ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„

- ìƒˆ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ í•´ì•¼ ì‘ì„± ê°€ëŠ¥
- ì‚­ì œ/ìˆ˜ì •ì€ ì‘ì„±ìë§Œ í•  ìˆ˜ ìˆìŒ

-> ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ì–´ì„œ ê´€ë¦¬í•  ì˜ˆì •. 



### ìŠ¤í‚¤ë§ˆ ìˆ˜ì •
- ê° í¬ìŠ¤íŠ¸ì˜ ì‘ì„±ìë¥¼ ì•Œì•„ì•¼ í•˜ë¯€ë¡œ, ê¸°ì¡´ì˜ Post ìŠ¤í‚¤ë§ˆë¥¼ ìˆ˜ì •í•´ì•¼ í•¨.

models/post.js

``` js
import mongoose from 'mongoose';

const { Schema } = mongoose;

// ìŠ¤í‚¤ë§ˆ ìƒì„±
const PostSchema = new Schema({
  title: String,
  body: String,
  tags: [String],
  publishedDate: {
    type: Date,
    default: Date.now,
  },
  
  // ğŸ”» user í•„ë“œ ì¶”ê°€í•´ì¤Œ. (idì™€ username)
  user: {
    _id: mongoose.Types.ObjectId,
    username: String,
  },
});

// ëª¨ë¸ ìƒì„±
const Post = mongoose.model('Post', PostSchema);

export default Post;

```

<br>

### posts ì»¬ë ‰ì…˜ ë¹„ìš°ê¸°
- ì´ì œ post ë°ì´í„°ì—ëŠ” ì‚¬ìš©ì ì •ë³´ê°€ í•„ìš”í•¨.
- ì´ì „ì— ìƒì„±í–ˆë˜ ê°€ì§œ ë°ì´í„°ë“¤ì€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ëª¨ë‘ ì‚­ì œí•´ì¤Œ.

- mongoDB compassë¥¼ ì—´ì–´ posts ì»¬ë ‰ì…˜ì„ ì‚­ì œí•´ì¤Œ.

![](https://velog.velcdn.com/images/thisisyjin/post/823b5d58-27a8-463f-9eb5-e32381528b2a/image.png)

<br>

### ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ API ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ ì„¤ì •

- ë¡œê·¸ì¸ ìƒíƒœì¸ì§€ í™•ì¸í•˜ê³ , APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ êµ¬í˜„.
- ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„í•¨.


- src/lib ë””ë ‰í„°ë¦¬ì— `checkLoggedIn.js` íŒŒì¼ ìƒì„±

``` js
const checkLoggedIn = (ctx, next) => {
  if (!ctx.state.user) {
    ctx.status = 401;
    return;
  }
  return next();
};

export default checkLoggedIn;
```

-> ë¡œê·¸ì¸ ìƒíƒœë¼ë©´ ctx.stateì— user í•„ë“œê°€ ì¡´ì¬í•  ê²ƒì„.
> jwtMiddleware ì— ì˜í•´ í† í° í™•ì¸ í›„ jwt.verifyí•œ ê°’ì„ ctx.state.user í•„ë“œì— ì €ì¥í•´ì¤¬ìŒ.
``` js
const jwtMiddleware = async (ctx, next) => {
  const token = ctx.cookies.get('access_token');
  if (!token) return next(); // í† í°ì´ ì—†ì„ ë•Œ
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    ctx.state.user = {
      _id: decoded._id,
      username: decoded.username,
    };
  ...
```
<br>

### posts ë¼ìš°í„°ì— ë¯¸ë“¤ì›¨ì–´ ë“±ë¡


api/posts/index.js ìˆ˜ì •

``` js
import Router from 'koa-router';
import { list, write, read, remove, update, checkObjectId } from './posts.ctrl';
import checkLoggedIn from '../../lib/checkLoggedIn';

const posts = new Router();

posts.get('/', list);
// ğŸ”» write, remove, update APIì—ì„œëŠ” checkLoggedIn ì¶”ê°€.
posts.post('/', checkLoggedIn, write);
posts.get('/:id', checkObjectId, read);
posts.delete('/:id', checkLoggedIn, checkObjectId, remove);
posts.patch('/:id', checkLoggedIn, checkObjectId, update);

export default posts;

```
<br>

### í¬ìŠ¤íŠ¸ ì‘ì„±ì‹œ ì‚¬ìš©ì ì •ë³´ ë„£ê¸°

posts.ctrl.js ìˆ˜ì •
-> write API

``` js
  const schema = Joi.object().keys({
    title: Joi.string().required(),
    body: Joi.string().required(),
    tags: Joi.array().items(Joi.string()).required(),
  });
  const result = schema.validate(ctx.request.body);
  if (result.error) {
    ctx.status = 400;
    ctx.body = result.error;
    return;
  }

  const { title, body, tags } = ctx.request.body;
  const post = new Post({ title, body, tags, user: ctx.state.user });

  try {
    await post.save();
    ctx.body = post;
  } catch (e) {
    ctx.throw(500, e);
  }
};
```

- postmanì—ì„œ POST ìš”ì²­ì„ í•´ë³¸ë‹¤.
-> ì•„ë˜ì™€ ê°™ì´ "user" í•„ë“œê°€ ìƒì„±ëœë‹¤.
-> ëˆ„ê°€ ì‘ì„±í–ˆëŠ”ì§€ í™•ì¸ ê°€ëŠ¥í•´ì§.
![](https://velog.velcdn.com/images/thisisyjin/post/ee6ed7ff-290a-43f4-852a-53a906ca613b/image.png)



<br>

### í¬ìŠ¤íŠ¸ ìˆ˜ì •,ì‚­ì œì‹œ ê¶Œí•œ í™•ì¸


#### 1. getPostById ë¯¸ë“¤ì›¨ì–´

- ì´ ì‘ì—…ì„ ë¯¸ë“¤ì›¨ì–´ë¡œ í•˜ë ¤ë©´? ğŸ‘‰ **idë¡œ í¬ìŠ¤íŠ¸ë¥¼ ì¡°íšŒí•˜ëŠ” ì‘ì—…**ë„ ë¯¸ë“¤ì›¨ì–´ë¡œ í•´ì¤˜ì•¼ í•¨.
- ê¸°ì¡´ì— ë§Œë“¤ì—ˆë˜ `checkObjectId`ë¥¼ `getPostById`ë¡œ ë°”ê¿”ì¤€ í›„, ì½”ë“œë¥¼ ìˆ˜ì •.

ğŸ”» ê¸°ì¡´ ì½”ë“œ
posts.ctrl.js -> getPostById
``` js
export const checkObjectId = (ctx, next) => {
  const { id } = ctx.params;
  if (!ObjectId.isValid(id)) {
    ctx.status = 400; // Bad Request
    return;
  }
  return next();
};
```

ğŸ”» ìˆ˜ì • í›„


``` js
export const getPostById = async (ctx, next) => {
  const { id } = ctx.params;
  if (!ObjectId.isValid(id)) {
    ctx.status = 400; // Bad Request
    return;
  }
  try {
    const post = await Post.findById(id);
    if (!post) {
      ctx.status = 404;
      return;
    }
    ctx.state.post = post;
    return next();
  } catch (e) {
    ctx.throw(500, e);
  }
};
```


#### 2. posts/index.js ìˆ˜ì •
getPostByIdë¡œ ì „ë¶€ ë°”ê¿”ì¤Œ.
```js
import Router from 'koa-router';
import { list, write, read, remove, update, getPostById } from './posts.ctrl';
import checkLoggedIn from '../../lib/checkLoggedIn';

const posts = new Router();

posts.get('/', list);
posts.post('/', checkLoggedIn, write);
posts.get('/:id', getPostById, read);
posts.delete('/:id', checkLoggedIn, getPostById, remove);
posts.patch('/:id', checkLoggedIn, getPostById, update);

export default posts;
```


#### 3. read API ìˆ˜ì •

``` js
export const read = (ctx) => {
  ctx.body = ctx.state.post;
};
```
-> íŠ¹ì • idë¡œ í¬ìŠ¤íŠ¸ë¥¼ ì°¾ëŠ” ê¸°ëŠ¥ì„ í•˜ëŠ” read APIì˜ ì½”ë“œë¥¼ ê°„ì†Œí™” í•  ìˆ˜ ìˆìŒ.


#### 4. checkOwnPost ë¯¸ë“¤ì›¨ì–´

posts.ctrl.js ìˆ˜ì •

``` js
export const checkOwnPost = (ctx, next) => {
  const { user, post } = ctx.state;
  if (post.user._id.toString() !== user._id) {
    ctx.status = 403;
    return;
  }
  return next();
}
```
- postì˜ êµ¬ì¡°ë¥¼ ì‚´í´ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ `post.user._id`ê°€ ìˆê³ ,
![](https://velog.velcdn.com/images/thisisyjin/post/949d32b3-2655-4c55-b0b5-98312d5ba9ce/image.png)
- userì˜ êµ¬ì¡°ë¥¼ ì‚´í´ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ `user._id`ê°€ ìˆìŒ.
![](https://velog.velcdn.com/images/thisisyjin/post/41d15f97-4b6c-4c82-a0a8-4a8ae6ffbf01/image.png)
-> ìœ„ ë‘ê°œì˜ `_id` ëŠ” ì¼ì¹˜í•¨. ì¦‰ ê°™ì€ ìœ ì €ì„.


ì´ì™€ ê°™ì´ idê°’ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì—¬

> â—ï¸ ì£¼ì˜ - mongoDBì—ì„œ ì¡°íšŒí•œ ë°ì´í„°ì˜ id ê°’ì„ ë¬¸ìì—´ê³¼ ë¹„êµí• ë•ŒëŠ” ë°˜ë“œì‹œ `.toString()`ì„ í•´ì¤Œ.


#### 5. ë¯¸ë“¤ì›¨ì–´ ë“±ë¡

posts ë¼ìš°í„°ì— checkOwnPost ë¯¸ë“¤ì›¨ì–´ë¥¼ ë¶ˆëŸ¬ì¤Œ.
``` js
import Router from 'koa-router';
import {
  list,
  write,
  read,
  remove,
  update,
  getPostById,
  checkOwnPost,
} from './posts.ctrl';
import checkLoggedIn from '../../lib/checkLoggedIn';

const posts = new Router();

posts.get('/', list);
posts.post('/', checkLoggedIn, write);
posts.get('/:id', getPostById, read);
posts.delete('/:id', checkLoggedIn, getPostById, checkOwnPost, remove);
posts.patch('/:id', checkLoggedIn, getPostById, checkOwnPost, update);

export default posts;

```

### Test

ê¸€ì„ ì‘ì„±í•œ ê³„ì •ê³¼ ë‹¤ë¥¸ ìƒˆë¡œìš´ ê³„ì •ì„ ë§Œë“  í›„, ê·¸ ê¸€ì„ ì‚­ì œí•˜ë ¤ í•˜ë©´ 403 ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.

![](https://velog.velcdn.com/images/thisisyjin/post/13a81b96-b335-4afa-b393-17e26bc6fc50/image.png)

***


## í¬ìŠ¤íŠ¸ í•„í„°ë§

- íŠ¹ì • ì‚¬ìš©ìê°€ ì‘ì„±í•œ í¬ìŠ¤íŠ¸ë§Œ ì¡°íšŒ = `username` ìœ¼ë¡œ í•„í„°ë§
- íŠ¹ì • íƒœê·¸ê°€ ìˆëŠ” í¬ìŠ¤íŠ¸ë§Œ ì¡°íšŒ = `tags` ë¡œ í•„í„°ë§


posts.ctrl.js ìˆ˜ì •
-> list API

``` js
export const list = async (ctx) => {
  const page = parseInt(ctx.query.page || '1');

  if (page < 1) {
    ctx.status = 400;
    return;
  }
  // ğŸ”» ctx.query (ì£¼ì†Œì˜ ì¿¼ë¦¬ìŠ¤íŠ¸ë§) -> ì˜ˆ) ?username=yjin
  const { tag, username } = ctx.query;
  // ğŸ”» tag, usernameì´ ìˆìœ¼ë©´ ê°ì²´ ì•Šì— ë„£ê³  ì•„ë‹ˆë©´ ë¹ˆ ê°ì²´ë¡œ
  const query = {
    ...(username ? { 'user.username': username } : {}),
    ...(tag ? { tags: tag } : {}),
  };

  try {
    // ğŸ”» find() ì˜ ì¸ìë¡œ queryë¥¼ ë„£ì–´ì¤Œ. 
    const posts = await Post.find(query)
      .sort({ _id: -1 })
      .limit(10)**í…ìŠ¤íŠ¸**
      .skip((page - 1) * 10)
      .exec();

    const postCount = await Post.countDocuments(query).exec(); // ë¬¸ì„œ ìˆ˜ ëª‡ê°œì¸ì§€ ê°€ì ¸ì˜´
    ctx.set('Last-page', Math.ceil(postCount / 10)); // í˜ì´ì§€ ìˆ˜ ì¹´ìš´íŠ¸

    ctx.body = posts
      .map((post) => post.toJSON())
      .map((post) => ({
        ...post,
        body:
          post.body.length < 200 ? post.body : `${post.body.slice(0, 200)}...`,
      }));
  } catch (e) {
    ctx.throw(500, e);
  }
};
```

### Test

1) usernameìœ¼ë¡œ ê²€ìƒ‰

GET ìš”ì²­ - api/posts**?username=yjin**

![](https://velog.velcdn.com/images/thisisyjin/post/4776a47f-9289-4450-91a9-ce394febc4e9/image.png)



2) tags ë¡œ ê²€ìƒ‰

GET ìš”ì²­ - api/posts**?tag=íƒœê·¸1**
![](https://velog.velcdn.com/images/thisisyjin/post/f51fac0e-45ca-4d88-99f5-7d591b1df4b8/image.png)
