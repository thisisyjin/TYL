# React.js

**Today I Learned ... **`react.js`

>ğŸ™‹â€â™‚ï¸ [**Reference Book**](https://nomadcoders.co/react-hooks-introduction)

>ğŸ™‹â€ [**My Dev Blog**](https://mywebproject.tistory.com/)

***

> ** CH 23. JWTë¥¼ í†µí•œ íšŒì› ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ **
- JWT (JSON Web Token)
- posts APIì— íšŒì›ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„


## JWT
= JSON Web Token.
- ë°ì´í„°ê°€ JSONìœ¼ë¡œ ì´ë£¨ì–´ì ¸ ìˆëŠ” í† í°.
- ë‘ ê°œì²´ê°€ ì•ˆì „í•˜ê²Œ ì •ë³´ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆë„ë¡ ì›¹ í‘œì¤€ìœ¼ë¡œ ì •ì˜ëœ ê¸°ìˆ .


- ì‚¬ìš©ì ë¡œê·¸ì¸ ìƒíƒœë¥¼ ì²˜ë¦¬í•˜ëŠ” ë‘ê°€ì§€ ì¸ì¦ ë°©ì‹ì´ ì¡´ì¬í•¨.
### ì„¸ì…˜ê¸°ë°˜ ì¸ì¦
- ì„œë²„ê°€ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ì¤‘ì„ì„ ê¸°ì–µí•˜ê³  ìˆìŒ.
- ì„¸ì…˜ ì €ì¥ì†Œì— ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³ , ì„¸ì…˜ idë¥¼ ë°œê¸‰.
-> ì£¼ë¡œ ë¸Œë¼ìš°ì €ì˜ ì¿ í‚¤ì— ì €ì¥í•¨.
- ì‚¬ìš©ìê°€ ë‹¤ë¥¸ ìš”ì²­ì„ í•  ë•Œë§ˆë‹¤ ì„œë²„ëŠ” ì„¸ì…˜ì„ ì¡°íšŒí•œ í›„, ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ì—¬ ì‘ë‹µí•¨.


- ğŸ‘ ë‹¨ì  - ì„œë²„ í™•ì¥ì´ ë²ˆê±°ë¡œì›€. ì„œë²„ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—¬ëŸ¬ê°œê°€ ëœë‹¤ë©´, ì„¸ì…˜ ì „ìš© ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•¨.

### í† í°ê¸°ë°˜ ì¸ì¦
- í† í° = ë¡œê·¸ì¸ ì´í›„ ì„œë²„ê°€ ë§Œë“¤ì–´ì£¼ëŠ” ë¬¸ìì—´
- í† í° ì•ˆì—ëŠ” ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ì •ë³´ê°€ ë“¤ì–´ìˆê³ , í•´ë‹¹ ì •ë³´ê°€ ì„œë²„ì—ì„œ ë°œê¸‰ë˜ì—ˆë‹¤ëŠ” ì„œëª…ì´ ë“¤ì–´ìˆìŒ.

- ì„œëª… ë°ì´í„°ëŠ” í•´ì‹±(Hashing) ì•Œê³ ë¦¬ì¦˜ì„ í†µí•´ ë§Œë“¤ì–´ì§.
> #### ğŸ™‹â€â™‚ï¸ í•´ì‹± í•¨ìˆ˜ 
ì„ì˜ì˜ ê¸¸ì´ì˜ ë°ì´í„°ë¥¼ ê³ ì •ëœ ê¸¸ì´ì˜ ë°ì´í„°ë¡œ ë§¤í•‘í•˜ëŠ” í•¨ìˆ˜ì´ë‹¤. 
í•´ì‹œ í•¨ìˆ˜ì— ì˜í•´ ì–»ì–´ì§€ëŠ” ê°’ì€ í•´ì‹œ ê°’, í•´ì‹œ ì½”ë“œ, í•´ì‹œ ì²´í¬ì„¬ ë˜ëŠ” ê°„ë‹¨í•˜ê²Œ í•´ì‹œë¼ê³  í•œë‹¤.


- ì„œë²„ì—ì„œ ë§Œë“¤ì–´ì¤€ í† í°ì€ ì„œëª…ì´ ìˆë¼ ë•Œë¬¸ì— ë¬´ê²°ì„±ì´ ë³´ì¥ë¨. (ì •ë³´ê°€ ë³€ê²½ or ìœ„ì¡°ë˜ì§€ ì•ŠìŒ)
- ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ì„ í•˜ë©´ ì„œë²„ì—ì„œ í† í°ì„ ë°œê¸‰í•´ì£¼ê³ ,
- ì‚¬ìš©ìê°€ ë‹¤ë¥¸ ìš”ì²­ì„ í• ë•Œ ë°œê¸‰ë°›ì€ í† í°ê³¼ í•¨ê»˜ ìš”ì²­í•˜ê²Œ ë¨.
- ì„œë²„ëŠ” í•´ë‹¹ í† í°ì´ ìœ íš¨í•œì§€ ê²€ì‚¬í•˜ê³ , ì‘ë‹µí•¨.


- ğŸ‘ ì¥ì  - ì„œë²„ì—ì„œ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ê¸°ì–µí•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ë¦¬ì†ŒìŠ¤ê°€ ì ë‹¤.
-> ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ì •ë³´ê°€ ë‹´ê¸´ í† í°ì„ ì§€ë‹ˆê³  ìˆìœ¼ë¯€ë¡œ.
- ì„œë²„ì˜ í™•ì¥ì„±ì´ ë§¤ìš° ë†’ë‹¤.
-> ì„œë²„ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ëŠ˜ì–´ë‚˜ë„ ì„œë²„ë¼ë¦¬ ì‚¬ìš©ì ë¡œê·¸ì¸ ìƒíƒœë¥¼ ê³µìœ í•˜ì§€ X.
- ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ ê°„í¸


***

## JWT ì¸ì¦ êµ¬í˜„

### User ìŠ¤í‚¤ë§ˆ/ëª¨ë¸ ìƒì„±

- ì‚¬ìš©ì ì •ë³´ë¥¼ MongoDBì— ë‹´ê³  ì¡°íšŒ
- ìŠ¤í‚¤ë§ˆë¡œëŠ” ê³„ì •ëª… / ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”.
- ë¹„ë°€ë²ˆí˜¸ì˜ ê²½ìš°ì—ëŠ” ë³´ì•ˆìƒ ì¤‘ìš”í•˜ë¯€ë¡œ,
**ë‹¨ë°©í–¥ í•´ì‹± í•¨ìˆ˜**ë¥¼ ì§€ì›í•´ì£¼ëŠ” `bcrypt` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì•ˆì „í•˜ê²Œ ì €ì¥.

> ë‹¨, ë¹„ë°€ë²ˆí˜¸ëŠ” mongoDBì— ì €ì¥ë˜ê¸° ì „ì— ([saveí•¨ìˆ˜](https://velog.io/@thisisyjin/TIL-22-05-16-2#1-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%83%9D%EC%84%B1)ë¡œ ì €ì¥) í•´ì‹± ì²˜ë¦¬ê°€ ë˜ì–´ì•¼ í•¨.

#### /src/models/user.js ìƒì„±
``` js
import mongoose, { Schema } from 'mongoose';

// ìŠ¤í‚¤ë§ˆ ìƒì„±
const UserSchema = new Schema({
  username: String,
  hashedPassword: String,
});

// ëª¨ë¸ ìƒì„±
const User = mongoose.model('User', UserSchema);
export default User;

```

#### bcrypt ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
``` bash
$ yarn add bcrypt
```


***

## ëª¨ë¸ ë©”ì„œë“œ ìƒì„±

> #### ğŸ™‹â€â™€ï¸ ëª¨ë¸ ë©”ì„œë“œë€?
- ëª¨ë¸ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜.

- 1) ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œ = ëª¨ë¸ì„ í†µí•´ ë§Œë“  **ë¬¸ì„œ ì¸ìŠ¤í„´ìŠ¤**ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜
``` js
const user = new User({username: 'yjin'});
user.setPassword('1234');   // userì€ ë¬¸ì„œ ì¸ìŠ¤í„´ìŠ¤ = new Model({doc})
```

- 2) ìŠ¤íƒœí‹± ë©”ì„œë“œ = ëª¨ë¸ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜
``` js
const user = User.findByUsername('yjin');  
```


### 1. ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œ ìƒì„±

models/user.js ìˆ˜ì •
``` js
import mongoose, { Schema } from 'mongoose';
import bcrypt from 'bcrypt';

// ìŠ¤í‚¤ë§ˆ ìƒì„±
const UserSchema = new Schema({
  username: String,
  hashedPassword: String,
});

// ğŸ”» ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œ ì‘ì„± ì‹œ í™”ì‚´í‘œ í•¨ìˆ˜ëŠ” âŒ (this ë°”ì¸ë”© ë•Œë¬¸)
UserSchema.methods.setPassword = async function (password) {
  const hash = await bcrypt.hash(password, 10);
  this.hashedPassword = hash;  // ì—¬ê¸°ì„œ thisëŠ” ë¬¸ì„œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ë¦¬í‚´.
};

UserSchema.methods.checkPassword = async function (password) {
  const result = await bcrypt.compare(password, this.hashedPassword);
  return result;
};

// ëª¨ë¸ ìƒì„±
const User = mongoose.model('User', UserSchema);
export default User;

```

#### setPassword
- ë¹„ë°€ë²ˆí˜¸ë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì•„ì„œ ê³„ì •ì˜ hashedPassword ê°’ì„ ì„¤ì •í•´ì¤Œ.

#### checkPassword
- ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì€ ë¹„ë°€ë²ˆí˜¸ê°€ í•´ë‹¹ ê³„ì •ì˜ ë¹„ë°€ë²ˆí˜¸ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦ 

-> ë‘˜ë‹¤ async/await í•¨ìˆ˜ë¡œ ì‘ì„±í•´ì¤Œ.

<br>


#### âœ… bcryptì˜ `hash()` í•¨ìˆ˜ì™€ `compare`í•¨ìˆ˜
- **hash(í”Œë ˆì¸ í…ìŠ¤íŠ¸, salt)**
-> ìˆ«ì 10ì€ saltë¡œ, ë†’ì„ ìˆ˜ë¡ ì•”í˜¸í™” ì—°ì‚°ì´ ì¦ê°€. (í•˜ì§€ë§Œ ì•”í˜¸í™”í•˜ëŠ”ë° ì†ë„ê°€ ëŠë ¤ì§)

- **compare(í”Œë ˆì¸ í…ìŠ¤íŠ¸, í•´ì‹œê°’)**


### 2. ìŠ¤íƒœí‹± ë©”ì„œë“œ ìƒì„±

- findByUsername ë©”ì„œë“œ
-> `username` ìœ¼ë¡œ íŠ¹ì • ë°ì´í„°ë¥¼ ì°¾ê²Œ í•´ì¤Œ.


models/user.js ìˆ˜ì •
``` js
UserSchema.statics.findByUsername = function (username) {
  return this.findOne({ username }); // ğŸ‘ˆ username: usernameì¸ ë¬¸ì„œë¥¼ ì°¾ê¸°.
};
```

-> ìŠ¤íƒœí‹± í•¨ìˆ˜ì—ì„œì˜ thisëŠ” ëª¨ë¸ì„ ê°€ë¦¬í‚´. (=User)

> #### ğŸ“Œ Model.findOne()
- ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ë¬¸ì„œë¥¼ ì°¾ì•„ì¤Œ. 
- ë§Œì•½ ë¬¸ì„œì˜ íŠ¹ì • í•„ë“œë§Œ ë³´ê³ ì‹¶ë‹¤ë©´ ë‘ë²ˆì§¸ ì¸ìë¡œ ë„£ì–´ì¤Œ.
- [ê³µì‹ ë§¤ë‰´ì–¼](https://mongoosejs.com/docs/api.html#model_Model.findOne) ì°¸ê³ 


***

## íšŒì› ì¸ì¦ API


### ìƒˆë¡œìš´ ë¼ìš°íŠ¸ ì •ì˜


1. src/api/auth ë””ë ‰í„°ë¦¬ë¥¼ ìƒì„±í•˜ê³ , `auth.ctrl.js` íŒŒì¼ì„ ë¨¼ì € ë§Œë“ ë‹¤.
-> ì»¨íŠ¸ë¡¤ëŸ¬ íŒŒì¼ì´ë¯€ë¡œ, ë¼ìš°íŠ¸ ì²˜ë¦¬í•¨ìˆ˜(=ë¯¸ë“¤ì›¨ì–´)ë¥¼ ëª¨ì•„ë†“ì€ íŒŒì¼ì„.

auth.ctrl.js
``` js
export const register = async (ctx) => {
  // íšŒì› ê°€ì… (ë“±ë¡)
};

export const login = async (ctx) => {
  // ë¡œê·¸ì¸
};

export const check = async (ctx) => {
  // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
};

export const logout = async (ctx) => {
  // ë¡œê·¸ì•„ì›ƒ
};
```

2. src/api/auth ë””ë ‰í„°ë¦¬ì— `index.js`ë¥¼ ìƒì„±í•´ì¤€ë‹¤.
-> auth ë¼ìš°í„° ìƒì„±.

``` js
import Router from 'koa-router';
import * as authCtrl from './auth.ctrl';

const auth = new Router();

auth.post('/register', authCtrl.register);
auth.post('/login', authCtrl.login);
auth.get('/check', authCtrl.check);
auth.post('/logout', authCtrl.logout);

export default auth;

```

- íšŒì›ê°€ì…, ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒì€ ëª¨ë‘ ë³´ì•ˆìƒ ì¤‘ìš”í•˜ë¯€ë¡œ POST ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
-> GET ë°©ì‹ì€ uriì˜ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ìœ¼ë¡œ ìš”ì²­ì´ ë‹¤ ë³´ì´ë¯€ë¡œ ì•ˆë¨.


3. src/api/index.js ì—ì„œ
api ë¼ìš°í„°ì— `auth` ë¼ìš°í„°ë¥¼ ë¶ˆëŸ¬ì™€ ì ìš©í•œë‹¤.
``` js
import Router from 'koa-router';
import posts from './posts';
import auth from './auth/index';

const api = new Router();

api.use('/posts', posts.routes());
api.use('/auth', auth.routes());

export default api;

```

***

## 1. íšŒì›ê°€ì… êµ¬í˜„

src/api/auth/auth.ctrl.js ìˆ˜ì •
-> register API
``` js
// 1. íšŒì› ê°€ì… (ë“±ë¡)
export const register = async (ctx) => {
  // request body ê²€ì¦
  const schema = Joi.object().keys({
    username: Joi.string().alphanum().min(3).max(20).required(),
    password: Joi.string().required(),
  });

  const result = schema.validate(ctx.request.body);

  if (result.error) {
    ctx.status = 400;
    ctx.body = result.error;
    return;
  }

  const { username, password } = ctx.request.body;
  try {
    // username ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ ì²´í¬
    const exists = await User.findByUsername(username);
    if (exists) {
      ctx.status = 409; // conflict
      return;
    }

    const user = new User({
      username,
    });
    await user.setPassword(password);
    await user.save(); // DBì— ì €ì¥

    const data = user.toJSON();
    delete data.hashedPassword;

    ctx.body = data;
  } catch (e) {
    ctx.throw(500, e);
  }
};
```
1. Joi ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ê²€ì¦
-> schema ê°ì²´ ìƒì„± (ë°ì´í„°íƒ€ì… ìœ íš¨ì„±ì„ ë‹´ì€ ê°ì²´)
-> schema.validate(ctx.request.body)ë¡œ ê²€ì‚¬í•¨
-> result.error í•„ë“œê°€ ì¡´ì¬í•˜ë©´ ì—ëŸ¬ê°€ ìˆëŠ” ê²ƒ. -> **400 ì—ëŸ¬ ë°œìƒ**ì‹œí‚´

2. username ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ ê²€ì‚¬
-> User ëª¨ë¸ì˜ ìŠ¤íƒœí‹± ë©”ì„œë“œì¸ **findByUsername**ì´ trueë©´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì„.
-> 409 ì—ëŸ¬ ë°œìƒì‹œí‚´

3. user ë¬¸ì„œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
-> new Model({ë¬¸ì„œ}) í•´ì„œ ë¬¸ì„œ ì¸ìŠ¤í„´ìŠ¤ì¸ `user` ë§Œë“¬.
-> **user.setPassword**ë¡œ ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œ ì‚¬ìš©.
-> this.hashedPasswordë¥¼ ì„¤ì •í•˜ëŠ” ë©”ì„œë“œì„. (í•´ì‹œì²˜ë¦¬í•´ì„œ)

4. DBì— ë“±ë¡ - `user.save()`

5. ctx.bodyì— ì‘ë‹µí•  ë°ì´í„°ì—ì„œ ë¹„ë°€ë²ˆí˜¸ëŠ” ì œì™¸í•´ì•¼ í•¨.
-> user ê°ì²´ë¥¼ ìˆ˜ì •í•˜ë ¤ë©´ user.toJSON()ì„ í•´ì„œ JSON ìœ¼ë¡œ ë°”ê¾¼ ë’¤ì— ìˆ˜ì •í•´ì•¼í•¨.
-> ê°ì²´ì˜ íŠ¹ì • í•„ë“œë¥¼ ì œê±°í•˜ë ¤ë©´ delte í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•¨. 

-> ì¶”í›„ì—ë„ ì‚¬ìš©í•´ì•¼ í•˜ë‹ˆ, `models/user.js`ì— ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œë¡œ ì¶”ê°€í•´ì£¼ì.
``` js
UserSchema.methods.serialize = function () {
  const data = this.toJSON();
  delete data.hashedPassword;
  return data;
};
```

6. ctx.body = data;ë¥¼ í•´ì„œ ì‘ë‹µí•¨


- ë§ˆì§€ë§‰ìœ¼ë¡œ, postmanìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ì.

![](https://velog.velcdn.com/images/thisisyjin/post/1491538a-dabd-42f8-bfe4-16d4e7bb2980/image.png)

http://localhost:4000/api/auth/register ì— POST ìš”ì²­ì„ í•œë‹¤.
request bodyëŠ” ìœ„ì™€ ê°™ì´ usernameê³¼ passwordë¥¼ ì…ë ¥í•œë‹¤.

-> ë°˜ë“œì‹œ response bodyì—ëŠ” passwordê°€ ì œì™¸ë˜ì–´ ìˆì–´ì•¼ í•¨.


- mongoDB compass
![](https://velog.velcdn.com/images/thisisyjin/post/00288a91-8c8a-4f47-b2bc-def9b91861fb/image.png)
-> 'blog' DBì— `users` ì»¬ë ‰ì…˜ì´ ì¶”ê°€ë˜ì—ˆë‹¤.


+) ë§Œì•½, ê°™ì€ usernameìœ¼ë¡œ í•œë²ˆ ë” register(POST)ì„ ìš”ì²­í•˜ë©´ 409 ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.
![](https://velog.velcdn.com/images/thisisyjin/post/16532b6c-9f81-4340-84cd-a395e36aa133/image.png)




***

## 2. ë¡œê·¸ì¸ êµ¬í˜„

auth.ctrl.js ìˆ˜ì •
-> login API

``` js
// 2. ë¡œê·¸ì¸
export const login = async (ctx) => {
  const { username, password } = ctx.request.body;

  // username, password ì—†ìœ¼ë©´ ì—ëŸ¬
  if (!username || !password) {
    ctx.status = 401; // Unauthorized
    return;
  }

  try {
    const user = await User.findByUsername(username);
    // usernameì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì—ëŸ¬
    if (!user) {
      ctx.status = 401;
      return;
    }
    const valid = await user.checkPassword(password);
    // password ë¶ˆì¼ì¹˜ì‹œ ì—ëŸ¬
    if (!valid) {
      ctx.staus = 401;
      return;
    }
    ctx.body = user.serialize();
  } catch (e) {
    ctx.throw(500, e);
  }
};

```

> `serialize()` ë©”ì„œë“œ
- í‘œì¤€ URL ì¸ì½”ë”© í‘œê¸°ë²•ìœ¼ë¡œ í…ìŠ¤íŠ¸ ë¬¸ìì—´ì„ ìƒì„±í•¨.

1. username, passwordê°’ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ì²˜ë¦¬

2. ìŠ¤íƒœí‹± ë©”ì„œë“œì¸ findByUsernameì„ í†µí•´ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì°¾ìŒ
-> ë§Œì•½ ì—†ìœ¼ë©´ ì—ëŸ¬ì²˜ë¦¬

3. ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œì¸ checkPasswordë¡œ ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
-> bcrypt.compareë¡œ í”Œë ˆì¸ í…ìŠ¤íŠ¸(=password)ì™€ í•´ì‹œê°’(=hashedPassword)ì„ ë¹„êµ
-> ì¼ì¹˜í•˜ë©´ true ë°˜í™˜
-> ì•„ë‹Œê²½ìš° 401 ì—ëŸ¬ ë°œìƒ

4. user.serialize()ë¥¼ í•œ í›„ ì‘ë‹µí•¨.
-> hashedPassword í•„ë“œë¥¼ ì œì™¸ì‹œí‚´.


- postman ì—ì„œ ë¡œê·¸ì¸ êµ¬í˜„í•´ë³´ê¸°.

![](https://velog.velcdn.com/images/thisisyjin/post/83fd0ade-c11f-4ad2-bf89-244098dfe1ef/image.png)

-> http://localhost:4000/api/auth/login  POST ìš”ì²­. 
-> request bodyëŠ” ìœ„ì™€ ê°™ì´ ì‘ì„±.


![](https://velog.velcdn.com/images/thisisyjin/post/eb6d6d3a-483c-4c00-adff-b089ddbabfaf/image.png) -> ë§Œì•½ í‹€ë¦° ë¹„ë°€ë²ˆí˜¸ë¼ë©´ ìœ„ì™€ ê°™ì´ 401 ì—ëŸ¬ ë°œìƒ.

***


## 3. í† í° ë°œê¸‰ ë° ì¸ì¦

- í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì§€ë‹ ìˆ˜ ìˆë„ë¡ **ì„œë²„ì—ì„œ í† í°ì„ ë°œê¸‰**í•´ì¤Œ.
- JWT í† í°ì„ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” `jsonwebtoken` ëª¨ë“ˆì´ í•„ìš”.


``` bash
$ yarn add jsonwebtoken
```

### ë¹„ë°€í‚¤ ì„¤ì •
- `.env` íŒŒì¼ì„ ì—´ì–´ì„œ JWT í† í° ìƒì„±ì‹œ ì‚¬ìš©í•  ë¹„ë°€í‚¤ë¥¼ ë§Œë“¬.
- ë¬¸ìì—´ë¡œ ì•„ë¬´ê±°ë‚˜ ì…ë ¥í•˜ë©´ ë¨.


> TIP - í„°ë¯¸ë„ì— ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì¹˜ë©´ ëœë¤ ë¬¸ìì—´ì„ ë§Œë“¤ì–´ì¤Œ.
``` bash
$ openssl rand -hex 64
```

ëœë¤ ê°’ì„ ë³µì‚¬í•´ .env íŒŒì¼ì—ì„œ JWT_SECRET ê°’ìœ¼ë¡œ ì„¤ì •.

ë¹„ë°€í‚¤ëŠ” ì™¸ë¶€ì— ê³µê°œë˜ë©´ ëˆ„êµ¬ë“ ì§€ ë§˜ëŒ€ë¡œ JWT í† í°ì„ ë°œê¸‰í•  ìˆ˜ ìˆì–´ ìœ„í—˜í•¨.


### í† í° ë°œê¸‰
- /models/user.js ì—ì„œ `generateToken` ì´ë¼ëŠ” ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œ ìƒì„±.
``` js
UserSchema.methods.generateToken = function () {
  const token = jwt.sign(
    {
      _id: this.id,
      username: this.username,
    },
    process.env.JWT_SECRET,
    {
      expiresIn: '7d',
    },
  );
  return token;
};
```

- generateToken ë©”ì„œë“œë¡œ ë¡œê·¸ì¸ ì„±ê³µì‹œ ì‚¬ìš©ìì—ê²Œ í† í°ì„ ë°œê¸‰í•´ì¤Œ.


> #### âœ… ì°¸ê³  -  jwt(jsonwebtoken)ì˜ í•¨ìˆ˜
- jwt.sign = í† í° ë°œê¸‰
``` js
jwt.sign(payload, secretKey, options);
```
- jwt.verify = í† í° ì¸ì¦(í™•ì¸)
``` js
jwt.verify(token, secretKey);
```


#### ğŸ”º ì‚¬ìš©ìê°€ í† í°ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•
1. ë¸Œë¼ìš°ì €ì˜ localStorageë‚˜ sessionStorage ë¥¼ ì´ìš©í•¨.
-> í¸ë¦¬í•˜ê³  êµ¬í˜„ë„ ì‰½ì§€ë§Œ, XSS (í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìŠ¤í¬ë¦½íŒ…)ì— ì·¨ì•½í•¨.


2. ì¿ í‚¤ì— ë‹´ì•„ì„œ ì‚¬ìš©í•¨.
- httpOnly ì†ì„± ì‚¬ìš©ì‹œ ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ë¡œë¶€í„°ëŠ” ì•ˆì „í•˜ì§€ë§Œ, CSRF ë¼ëŠ” ê³µê²©ì— ì·¨ì•½í•´ì§.
-> ê·¸ëŸ¬ë‚˜ CSRF í† í° ì‚¬ìš© ë° Referer ê²€ì¦ ë“±ì˜ ë°©ì‹ìœ¼ë¡œ ì œëŒ€ë¡œ ë§‰ì„ ìˆ˜ ìˆìŒ.

auth.ctrl.js ìˆ˜ì •
-> register, login API
``` js
const token = user.generateToken();
    ctx.cookies.set('access_token', token, {
      maxAge: 1000 * 60 * 60 * 24 * 7, // 7d
      httpOnly: true,
    });
```
->  `ctx.body = user.serialize()` ì•„ë˜ì¤„ì— ì ì–´ì¤Œ.
(ì¦‰, tryë¬¸ì˜ ìµœí•˜ë‹¨ì— ì ì–´ì¤Œ)


> cookies.set() ë©”ì„œë“œ
- [mdnë¬¸ì„œ](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies/set)
- ì²«ë²ˆì§¸ ì¸ìë¡œëŠ” ì¿ í‚¤ëª…(=ì´ë¦„)ì´ ë“¤ì–´ê°€ê³ 
- ë‘ë²ˆì§¸ ì¸ìë¡œëŠ” ë„£ì–´ì¤„ ë°ì´í„°ê°€ ë“¤ì–´ê°€ê³  
(ì—¬ê¸°ì„œëŠ” user.generateToken(), ì¦‰ jwt.sign()ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ í† í°ì´ ë“¤ì–´ê°)
- ì„¸ë²ˆì§¸ ì¸ìë¡œëŠ” detailsë“¤ì´ ë“¤ì–´ê°. (maxAgeëŠ” ìµœëŒ€ ìœ íš¨ê¸°ê°„)


- postmanì„ í†µí•´ ë¡œê·¸ì¸ ìš”ì²­ í›„ response í—¤ë”ì— `Set-cookie` ë¼ëŠ” í—¤ë”ê°€ ë³´ì„.

![](https://velog.velcdn.com/images/thisisyjin/post/8851feb1-8a20-4eff-8e24-88df9b9114ae/image.png)

+) ì¢Œì¸¡ Cookies íƒ­ ì—ì„œ access_token ì´ë¼ëŠ” ì´ë¦„ì˜ ì¿ í‚¤ê°€ ìƒì„±ëœ ê²ƒì„ ì•Œ ìˆ˜ ìˆìŒ.



### í† í° ê²€ì¦í•˜ê¸°
- ì‚¬ìš©ìì˜ í† í°ì„ í™•ì¸ í•œ í›„, ê²€ì¦í•˜ëŠ” ì‘ì—….
- ë¯¸ë“¤ì›¨ì–´ë¥¼ í†µí•´ ì²˜ë¦¬í•¨.


1. src/lib ë””ë ‰í„°ë¦¬ë¥¼ ë§Œë“¤ê³ , `jwtMiddleware.js` íŒŒì¼ì„ ìƒì„±.


jwtMiddleware.js
``` js
import jwt from 'jsonwebtoken';

const jwtMiddleware = (ctx, next) => {
  const token = ctx.cookies.get('access_token');
  if (!token) return next(); // í† í°ì´ ì—†ì„ ë•Œ
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    console.log(decoded);
    return next();
  } catch (e) {
    return next();
  }
};

export default jwtMiddleware;
```


2. main.js ìˆ˜ì • - ë¯¸ë“¤ì›¨ì–´ ì ìš©
- ìœ„ì—ì„œ ë§Œë“  jwtMiddlewareë¥¼ ì ìš©.

``` js
import jwtMiddleware from './lib/jwtMiddleware';

  ...

// ë¼ìš°í„° ì ìš© ì „ì— ë¯¸ë“¤ì›¨ì–´ë¥¼ ì ìš©í•´ì•¼ í•¨
app.use(bodyParser());
// ğŸ”» ì¶”ê°€
app.use(jwtMiddleware);

  ...
```
<br>

3. Postmanì—ì„œ `/api/auth/check` ê²½ë¡œì— GET ìš”ì²­ì„ í•¨.
![](https://velog.velcdn.com/images/thisisyjin/post/9ce54f66-8542-4dde-9eec-16ae63da938c/image.png)

> iat : ì´ í† í°ì´ ì–¸ì œ ìƒì„±ë˜ì—ˆëŠ”ì§€.
exp: ì´ í† í°ì´ ì–¸ì œ ë§Œë£Œë˜ëŠ”ì§€.

- ì•„ì§ check API êµ¬í˜„ì„ ì•ˆí•´ì„œ 404 ì—ëŸ¬ê°€ ëœ¸.
- ê·¸ëŒ€ì‹  ì•„ë˜ì™€ ê°™ì´  `console.log(decoded)` ì— ì˜í•´ `jwt.verify()`ì˜ ê²°ê³¼ê°€ ì¶œë ¥ë¨.
-> ì´ ê°’ì„ ì´í›„ ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ctx.stateì— ë„£ì–´ì£¼ë©´ ë¨.


> ğŸ”º ì°¸ê³  - `jwt.verify`
``` js
jwt.verify(token, secretKey);
```
- ì°¸ê³ ë¡œ Joi ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ validate í•¨ìˆ˜(=ê²€ì¦) ê³¼ëŠ” ë‹¤ë¥´ë‹ˆ ì˜ êµ¬ë¶„í•˜ì.

<br>

4. ctx.stateì— ë„£ì–´ì¤Œ
jwtMiddleware.js ìˆ˜ì •

``` js
import jwt from 'jsonwebtoken';

const jwtMiddleware = (ctx, next) => {
  const token = ctx.cookies.get('access_token');
  if (!token) return next(); // í† í°ì´ ì—†ì„ ë•Œ
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    // ğŸ”» ì¶”ê°€
    ctx.state.user = {
      _id: decoded._id,
      username: decoded.username,
    };
    
    console.log(decoded);
    return next();
  } catch (e) {
    return next();
  }
};

export default jwtMiddleware;

```
<br>

5. `auth.ctrl.js`ì˜ ***check API*** êµ¬í˜„

``` js
// 3. ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
export const check = async (ctx) => {
  const { user } = ctx.state;
  // ë¡œê·¸ì¸ì¤‘ì´ ì•„ë‹ ë•Œ
  if (!user) {
    ctx.status = 401;
    return;
  }
  ctx.body = user;
};
```

6. ë§ˆì§€ë§‰ìœ¼ë¡œ, postmanìœ¼ë¡œ GET ìš”ì²­ì„ í•´ë³´ì.

![](https://velog.velcdn.com/images/thisisyjin/post/25eca462-2c0a-49ee-93e0-9a78f5d9fdb5/image.png)


### í† í° ì¬ë°œê¸‰

- jwtMiddlewareì—ì„œ `jwt.verify()`ëœ ê°’, ì¦‰ `decoded`ì—ì„œ expëŠ” ë§Œë£Œì¼ì„ ì•Œë ¤ì£¼ëŠ” ê°’ì´ì˜€ë‹¤.

- ë§Œì•½ expê°€ 3.5ì¼ ë¯¸ë§Œì´ë¼ë©´, í† í°ì„ ìƒˆë¡­ê²Œ ì¬ë°œê¸‰í•´ì£¼ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë³´ì.

jwtMiddleware.js ìˆ˜ì •
``` js
import jwt from 'jsonwebtoken';
import User from '../models/user';

const jwtMiddleware = async (ctx, next) => {
  const token = ctx.cookies.get('access_token');
  if (!token) return next(); // í† í°ì´ ì—†ì„ ë•Œ
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    ctx.state.user = {
      _id: decoded._id,
      username: decoded.username,
    };
	// ğŸ”» ì¶”ê°€ - expê°€ 3.5ì¼ ë¯¸ë§Œì´ë©´ í† í° ìƒˆë¡œ ë°œê¸‰
    const now = Math.floor(Date.now() / 1000);
    if (decoded.exp - now < 60 * 60 * 24 * 3.5) {
      const user = await User.findById(decoded._id);
      const token = user.generateToken(); // í† í° ìƒˆë¡œ ë°œê¸‰
      ctx.cookies.set('access_token', token, {
        maxAge: 1000 * 60 * 60 * 24 * 7, // 7d
        httpOnly: true,
      });
    }
    return next();
  } catch (e) {
    return next();
  }
};

export default jwtMiddleware;
```

- ìš°ì„ , async/await í•¨ìˆ˜ë¡œ ë°”ê¿”ì¤˜ì•¼ í•œë‹¤.
- User(ëª¨ë¸)ì„ ê°€ì ¸ì™€ì„œ ìŠ¤íƒœí‹± ë©”ì„œë“œì¸ findByIdì™€ ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œì¸ generateTokenì„ ì‚¬ìš©í•¨.


>â—ï¸ ì™œ Math.floor(Date.now() / 1000)ë¥¼ í–ˆë‚˜? 
- msê°€ ì•„ë‹Œ ì´ˆë‹¨ìœ„ë¡œ ë³´ê¸° ìœ„í•´
-> `exp: 1653366898` ì™€ ê°™ì´ sec ë‹¨ìœ„ì„! ë‹¨ìœ„ í†µì¼ì‹œì¼œì¤˜ì•¼í•¨.


- ì°¸ê³ ë¡œ, ë¡œê·¸ì¸ì‹œ (auth.ctrl.jsì˜ login API) í† í°ì„ ì²˜ìŒ ë°œê¸‰í•¨.
- ê·¸ ì´í›„ì—ëŠ” ì´ì œ ë¯¸ë“¤ì›¨ì–´ì—ì„œ expê°€ 3.5ì¼ ë¯¸ë§Œì¼ë•Œ ìƒˆë¡œ í† í°ì„ ë°œê¸‰í•´ì£¼ëŠ” ê²ƒ.


***

## 4. ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ êµ¬í˜„

- ë¡œê·¸ì•„ì›ƒì‹œ, ì¿ í‚¤ë¥¼ ì§€ì›Œì£¼ê¸°ë§Œ í•˜ë©´ ë¨.
- ctx.cookies.set('access-token')ë§Œ í•´ì£¼ë©´ ë¨.
-> ë‘ë²ˆì§¸ ì¸ìì— ì›ë˜ ê°’ì„ ì ì–´ì£¼ë©´ ì¿ í‚¤ ìƒì„±í•´ì£¼ê³ ,
ìœ„ì²˜ëŸ¼ ë‘ë²ˆì§¸ ì¸ìë¥¼ ì•ˆì£¼ë©´ í•´ë‹¹ ì´ë¦„ì„ ê°€ì§„ ì¿ í‚¤ë¥¼ ì‚­ì œí•´ì¤Œ.


auth.ctrl.js ìˆ˜ì •
``` js
// 4. ë¡œê·¸ì•„ì›ƒ
export const logout = async (ctx) => {
  ctx.cookies.set('access_token');
  ctx.status = 204;
};

```

<br>

ë§ˆì§€ë§‰ìœ¼ë¡œ, 
í™•ì¸ì„ ìœ„í•´ http://localhost:4000/api/auth/logout ë¡œ POST ìš”ì²­ì„ í•´ë³´ì.

![](https://velog.velcdn.com/images/thisisyjin/post/ac502e50-8099-47a6-9623-37944b5ca77d/image.png)


***

> ### ë‹¤ìŒ í¬ìŠ¤íŒ…
- posts APIì— íšŒì›ì¸ì¦ ì‹œìŠ¤í…œ ë„ì…
- username / tagsë¡œ í¬ìŠ¤íŠ¸ í•„í„°ë§ 



