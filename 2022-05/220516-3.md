# React.js

**Today I Learned ... **`react.js`

>ğŸ™‹â€â™‚ï¸ [**Reference Book**](https://nomadcoders.co/react-hooks-introduction)

>ğŸ™‹â€ [**My Dev Blog**](https://mywebproject.tistory.com/)

***

> ** CH 22. mongoDB + mongoose **
- ìš”ì²­ ê²€ì¦ (ObjectId, Request body)
- í˜ì´ì§€ë„¤ì´ì…˜ êµ¬í˜„


## request ê²€ì¦


### 1) ObjectId ê²€ì¦

- [ì´ì „ ê¸€](https://velog.io/@thisisyjin/TIL-22-05-16-2#2-2-%ED%8A%B9%EC%A0%95-%ED%8F%AC%EC%8A%A4%ED%8A%B8-%EC%A1%B0%ED%9A%8C)ì—ì„œ ì‘ì„±í•œ read APIë¥¼ ì‹¤í–‰í•  ë•Œ, idê°€ ì˜¬ë°”ë¥¸ ObjectId í˜•ì‹ì´ ì•„ë‹ ë•ŒëŠ” 500 errorê°€ ë°œìƒí•œë‹¤.
- 500 errorì€ ë³´í†µ ì„œë²„ ë¬¸ì œê°€ ë°œìƒí–ˆì„ë•Œì´ë‹¤.
-> ì˜ëª»ëœ idë¥¼ ì „ë‹¬í–ˆì„ ë•ŒëŠ” 400 (bad request)ë¥¼ ë„ì›Œì£¼ëŠ”ê²ƒì´ ë§ë‹¤.

ìœ„ì™€ ê°™ì€ ì´ìœ ë¡œ idê°€ ì˜¬ë°”ë¥¸ ObjectIdì¸ì§€ ê²€ì‚¬í•´ì•¼ í•œë‹¤.

``` js
import mongoose from 'mongoose';

const { ObjectId } = mongoose.Types;
ObjectId.isValid(id);
```

- ObjectIDë¥¼ ê²€ì¦í•´ì•¼ í•˜ëŠ” APIëŠ” idë¥¼ ì¡°íšŒí•˜ëŠ” read / remove / update API ì´ë‹¤.

- ì½”ë“œë¥¼ ì¤‘ë³µí•´ì„œ ë„£ì§€ ì•Šê³ , í•œ ë²ˆë§Œ êµ¬í˜„í•œ í›„ ì—¬ëŸ¬ ë¼ìš°íŠ¸ì— ì‰½ê²Œ ì ìš©í•˜ë ¤ë©´?
-> `ë¯¸ë“¤ì›¨ì–´`ë¥¼ ìƒì„±í•˜ë©´ ë¨!
-> ì½”ë“œ ìƒë‹¨ë¶€ì— ìƒì„± - ì¡°ê±´ì„ ë§Œì¡±í•´ì•¼ `next()`ë¡œ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ë¡œ ë„˜ì–´ê°ˆ ìˆ˜ ìˆë„ë¡.



1. posts/posts.ctrl.js **ìˆ˜ì •**
``` js
import Post from '../../models/post';
import mongoose from 'mongoose';

const { ObjectId } = mongoose.Types;

export const checkObjectId = (ctx, next) => {
  const { id } = ctx.params;
  if (!ObjectId.isValid(id)) {
    ctx.status = 400; // Bad Request
    return;
  }
  return next();
}

...
```
-> ObjectId.isValid(id)ê°€ falseë©´ 400 ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚´.

> - isValid()í•¨ìˆ˜ëŠ” mongooseì—ì„œ ì œê³µí•˜ëŠ” í•¨ìˆ˜ë¡œ, ê°’ì˜ ìœ íš¨ì„±ì„ ì²´í¬í•  ìˆ˜ ìˆë‹¤.
-> true/falseë¥¼ ë°˜í™˜í•¨.


2. posts/index.js **ìˆ˜ì •**
``` js
import Router from 'koa-router';
import { list, write, read, remove, update, checkObjectId } from './posts.ctrl';

const posts = new Router();

posts.get('/', list);
posts.post('/', write);
// ğŸ”» checkObjectId í•¨ìˆ˜ ì¶”ê°€ (ë‘ë²ˆì§¸ ì¸ìë¡œ)
posts.get('/:id', checkObjectId, read);
posts.delete('/:id', checkObjectId, remove);
posts.patch('/:id', checkObjectId, update);

export default posts;
```

2-2. posts/index.js **ë¦¬íŒ©í† ë§**

``` js
import Router from 'koa-router';
import { list, write, read, remove, update, checkObjectId } from './posts.ctrl';

const posts = new Router();

posts.get('/', list);
posts.post('/', write);

const post = new Router(); // /api/posts/:id
posts.get('/', read);
posts.delete('/', remove);
posts.patch('/', update);

posts.use('/:id', checkObjectId, post.routes());

export default posts;
```
- `/api/posts/:id` ê²½ë¡œë¥¼ ìœ„í•œ ë¼ìš°í„°ë¥¼ ìƒˆë¡œ ë§Œë“¬. (= post)
- **posts.use()** ë¡œ ë¼ìš°í„° ì¤‘ì²© ë“±ë¡í•´ì¤Œ.
-> `posts.use('/path', ë¼ìš°íŠ¸ëª….routes())`


- idë¥¼ ì¼ë°˜ ObjectIdì˜ ê¸¸ì´ì™€ ë‹¤ë¥¸ ì˜ëª»ëœ idë¥¼ ë„£ìœ¼ë©´, ì•„ë˜ì™€ ê°™ì´ 400 ì—ëŸ¬ê°€ ë°œìƒí•¨!
![](https://velog.velcdn.com/images/thisisyjin/post/376de4f3-52a2-42fc-b03d-dd9025416ae1/image.png)
(ì´ì „ì—ëŠ” 500ì—ëŸ¬ê°€ ë°œìƒí•˜ë˜ ê²ƒì„ ê°œì„ í•œ ê²ƒ)



<br>

### 2) Request Body ê²€ì¦

- write, updateì‹œì— ì „ë‹¬ë°›ì€ request ë‚´ìš©(body)ì„ ê²€ì¦í•˜ëŠ” ë°©ë²•.
- write API ì—ì„œëŠ” title, body, tagsë¥¼ ëª¨ë‘ ì „ë‹¬ë°›ì•„ì•¼ í•¨.
- í´ë¼ì´ì–¸íŠ¸ê°€ í•„ë“œ í•˜ë‚˜ë¼ë„ ë¹¼ë¨¹ìœ¼ë©´ 400 ì—ëŸ¬ë¥¼ ë°œìƒì‹œì¼œì•¼í•¨.


- ê°ì²´ë¥¼ ê²€ì¦í•˜ê¸° ìœ„í•´ì„œ  ifë¬¸ì„ ì“¸ìˆ˜ ìˆì§€ë§Œ, ë” ì‰½ê²Œ í•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ `Joi`ë¥¼ ì´ìš©.


#### Joi ë¼ì´ë¸ŒëŸ¬ë¦¬
``` bash
$ yarn add joi 
```

1. write í•¨ìˆ˜ ê²€ì¦

posts.ctrl.js ìˆ˜ì •
``` js
export const write = async (ctx) => {
  // ğŸ”» ìœ íš¨ì„± ê²€ì‚¬ (title,body,tags)
  const schema = Joi.object().keys({
    title: Joi.string().required(),
    body: Joi.string().required(),
    tags: Joi.array().items(Joi.string()).required(),
  });
  const result = schema.validate(ctx.request.body);
  if (result.error) {
    ctx.status = 400;
    ctx.body = result.error;
    return;
  }

  // ğŸ”½ ì´í•˜ ë™ì¼
  const { title, body, tags } = ctx.request.body;
  const post = new Post({ title, body, tags });

  try {
    await post.save();
    ctx.body = post;
  } catch (e) {
    ctx.throw(500, e);
  }
};
```


> Joi ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ê°ì²´ì˜ ê° í•„ë“œì˜ ê°’ì˜ ë°ì´í„°íƒ€ì… + í•„ìˆ˜(required())ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
-> `ì¡°ê±´ê°ì²´.validate(ê°ì²´)`ë¥¼ í•´ì„œ  í•´ë‹¹ ê°ì²´ê°€ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ”ì§€ ì–»ì„ ìˆ˜ ìˆë‹¤.
- [Joi ê³µì‹ ë¬¸ì„œ](https://joi.dev/api/?v=17.6.0) ì½ì–´ë³´ê¸°
- ëª¨ë“  ë°ì´í„°íƒ€ì…ì€ `Joi.___()`ì˜ í˜•íƒœë¡œ ìƒê²¼ë‹¤.
- ê²€ì¦ ì‹¤íŒ¨ì¸ ê²½ìš° `{... error: 'username" is required'}`ì™€ ê°™ì´  ì—ëŸ¬ í•„ë“œë¥¼ í¬í•¨í•œ ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤. 
-> ìœ„ì—ì„œ `result.error`ê°€ ìˆëŠ”ì§€ ifë¬¸ìœ¼ë¡œ ê±¸ëŸ¬ì„œ 400 ì—ëŸ¬ì²˜ë¦¬ í•´ì¤Œ.



2. update í•¨ìˆ˜ ê²€ì¦

- updateì˜ ê²½ìš°ì—ëŠ” required()ë¥¼ ì œì™¸í•˜ê³  íƒ€ì…ë§Œ ì„¤ì •í•´ì£¼ë©´ ëœë‹¤.
(ì•Œì•„ì„œ ì‘ì„±í•œ í•„ë“œë§Œ ë³€ê²½í•´ì£¼ë¯€ë¡œ ì „ë¶€ í•„ìˆ˜ëŠ” ì•„ë‹˜)

``` js
export const update = async (ctx) => {
  // ğŸ”» ìœ íš¨ì„± ê²€ì‚¬ (title,body,tags)
  const { id } = ctx.params;
  const schema = Joi.object().keys({
    title: Joi.string(),
    body: Joi.string(),
    tags: Joi.array().items(Joi.string()),
  });
  const result = schema.validate(ctx.request.body);
  if (result.error) {
    ctx.status = 400;
    ctx.body = result.error;
    return;
  }

  // ğŸ”½ ì´í•˜ ë™ì¼
  try {
    const post = await Post.findByIdAndUpdate(id, ctx.request.body, {
      new: true,
    }).exec();
    if (!post) {
      ctx.status = 404;
      return;
    }
    ctx.body = post;
  } catch (e) {
    ctx.throw(500, e);
  }
};

```

> âœ… ì°¸ê³  - `Joi.object({})`ì™€ `Joi.object().keys({})`
- keys() ë¥¼ ë¶™ì´ë©´ ì—¬ëŸ¬ í‚¤ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŒ.
- ë§Œì•½ ìŠ¤í‚¤ë§ˆë¥¼ í•˜ë‚˜ë§Œ ì •ì˜í• ê±°ë©´ `Joi.object({})`ë¡œ ì“°ê³ 
ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ (ì—¬ëŸ¬ê°œì˜ í‚¤ë¥¼ ê°–ëŠ”ë‹¤ë©´) `Joi.object().keys({})`ë¡œ ì“°ê¸°.
- [ì°¸ê³  ë§í¬](https://stackoverflow.com/questions/58811509/what-is-the-difference-between-joi-object-and-joi-object-keys)


![](https://velog.velcdn.com/images/thisisyjin/post/e89bb81d-b412-4b1d-a6e6-43239ec398f7/image.png)
- titleì„ ìˆ«ìí˜•ì‹ìœ¼ë¡œ ì…ë ¥ì‹œ 400 ì—ëŸ¬ ë°œìƒ.

***

## í˜ì´ì§€ë„¤ì´ì…˜

>âœ… í˜ì´ì§€ë„¤ì´ì…˜
- ì½˜í…ì¸ ë¥¼ ì—¬ëŸ¬ ê°œ í˜ì´ì§€ì— ë‚˜ëˆ ì„œ ë³´ì—¬ì£¼ëŠ” ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤.
- í˜ì´ì§€ í•˜ë‹¨ì— ìˆ«ìê°€ ë‚˜ì—´ëœ ê²ƒ.

- ë¸”ë¡œê·¸ì—ì„œ í¬ìŠ¤íŠ¸ ëª©ë¡ì€ í•œí˜ì´ì§€ë‹¹ 10-20ê°œ ë³´ì´ëŠ” ê²ƒì´ ì ë‹¹í•˜ë‹¤.
- (posts.ctrl.jsì˜) list APIë¥¼ ìˆ˜ì •í•´ì„œ í˜ì´ì§€ë„¤ì´ì…˜ì„ êµ¬í˜„í•´ë³´ì.


### ê°€ì§œ ë°ì´í„° ìƒì„±

í˜ì´ì§€ë„¤ì´ì…˜ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” ìš°ì„  ë°ì´í„°ê°€ ì¶©ë¶„íˆ ìˆì–´ì•¼ í•˜ë¯€ë¡œ, ê°€ì§œ ë°ì´í„°ë¥¼ ìƒì„±í•˜ëŠ” js íŒŒì¼ì„ ë§Œë“ ë‹¤.

- mongooseì˜ `insertMany()` í•¨ìˆ˜ë¥¼ ì´ìš©.

> âœ… insertMany()
The insertMany() function is used to insert multiple documents into a collection. It accepts an array of documents to insert into the collection.
-> ì»¬ë ‰ì…˜ì— ë§ì€ ë¬¸ì„œë¥¼ ë„£ê¸° ìœ„í•œ í•¨ìˆ˜ì„. (ë¬¸ì„œì˜ ë°°ì—´ í˜•íƒœë¡œ ëœ ê°’ì„ ë„£ìŒ)

1. src/createFackeData.js ìƒì„± 

``` js
import Post from './models/post';

export default function createFakeData() {
  const posts = [...Array(40).keys()].map((i) => ({
    title: `í¬ìŠ¤íŠ¸ #${i}`,
    body: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.',
    tags: ['fake', 'data'],
  }));

  Post.insertMany(posts, (err, docs) => {
    console.log(docs);
  });
}

```

2. main.jsì—ì„œ **createFackeData** í˜¸ì¶œ.
``` js
require('dotenv').config();
import Koa from 'koa';
import Router from 'koa-router';
import bodyParser from 'koa-bodyparser';
import mongoose from 'mongoose';

import api from './api';
// ğŸ”» ì„í¬íŠ¸í•˜ê¸°
import createFakeData from './createFakeData';

// process.env ë‚´ë¶€ ê°’ì— ëŒ€í•œ ë ˆí¼ëŸ°ìŠ¤
const { PORT, MONGO_URI } = process.env;

mongoose
  .connect(MONGO_URI)
  .then(() => {
    console.log('Connected to MongoDB');
  // ğŸ”» mongoDBì™€ ì—°ê²° í›„ì—, ê°€ì§œ ë°ì´í„° ë§Œë“¤ê¸°.
    createFakeData();
  })
  .catch((e) => {
    console.error(e);
  });

const app = new Koa();
const router = new Router();

router.use('/api', api.routes()); // api ë¼ìš°íŠ¸ ì ìš©

// ë¼ìš°í„° ì ìš© ì „ì— ë¯¸ë“¤ì›¨ì–´ë¥¼ ì ìš©í•´ì•¼ í•¨
app.use(bodyParser());

// app ì¸ìŠ¤í„´ìŠ¤ì— ë¼ìš°í„° ì ìš©
app.use(router.routes()).use(router.allowedMethods());

const port = PORT || 4000;
app.listen(port, () => {
  console.log('Listening to port ' + port);
});

```

![](https://velog.velcdn.com/images/thisisyjin/post/923de51d-7c81-4664-aa17-1bbada89a7a3/image.png)

ì´ëŸ°ì‹ìœ¼ë¡œ í„°ë¯¸ë„ì— ê°€ì§œ ë°ì´í„°ì˜ ì •ë³´ê°€ ì¶œë ¥ëœë‹¤. (console.log(docs)ì— ì˜í•´)
-> ì´ 40ê°œì˜ ê¸€ë“¤ì´ ì €ì¥ëœ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.


mongoDB compassì—ì„œ ìƒˆë¡œê³ ì¹¨ì„ í•˜ë©´ postsì— 40ê°œì˜ ë°ì´í„°ê°€ ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
(ì°¸ê³ ë¡œ, ì´ì „ì— postí–ˆë˜ ê¸€ë“¤ì€ ëª¨ë‘ delete í•´ì¤¬ìŒ)

![](https://velog.velcdn.com/images/thisisyjin/post/bca0c73f-f90d-429a-b88e-84bf6b90aa15/image.png)


> â—ï¸ ì£¼ì˜
- ë°ì´í„°ê°€ ì˜ ìƒì„±ëœ ê²ƒì„ í™•ì¸í–ˆìœ¼ë¯€ë¡œ, main.jsì—ì„œ createFakeDataë¥¼ í˜¸ì¶œí•˜ëŠ” ì½”ë“œë¥¼ ì‚­ì œí•´ì¤€ë‹¤.
-> ì´ë¯¸ ìƒì„±ë˜ì—ˆìœ¼ë¯€ë¡œ ì´ì œ í•„ìš”ì—†ìŒ!


<br>

### 1) í¬ìŠ¤íŠ¸ ì—­ìˆœìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°

- ê°€ì¥ ìµœê·¼ ì‘ì„±ëœ í¬ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ë³´ì—¬ì£¼ê¸° ìœ„í•´.
- list API ìˆ˜ì •

posts.ctrl.js ìˆ˜ì •

``` js
export const list = async (ctx) => {
  try {
    // ğŸ”» sort({ _id: -1 })ì„  .exec()  ì•ì— ë„£ì–´ì¤Œ.
    const posts = await Post.find().sort({ _id: -1 }).exec();
    ctx.body = posts;
  } catch (e) {
    ctx.throw(500, e);
  }
};
```

-> exec()ì„ í•˜ê¸° ì „ì— sort() êµ¬ë¬¸ì„ ë„£ì–´ì¤€ë‹¤. ( idë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬í•˜ë„ë¡ )
->  idê°€ í´ìˆ˜ë¡ ìµœì‹ ì— ì‘ì„±í•œ ê¸€ì„. ì¦‰, í°ê°’ë¶€í„° ì •ë ¬ = ë‚´ë¦¼ì°¨ìˆœ.

> #### âš¡ï¸ sort()
sort í•¨ìˆ˜ì˜ íŒŒë¼ë¯¸í„°ëŠ” { key: 1 } ë˜ëŠ” { key: -1 } ë¡œ ì ì–´ì¤Œ.
- keyëŠ” ì •ë ¬í•  í•„ë“œë¥¼ ì„¤ì •í•˜ëŠ” ê²ƒì´ê³ ,
- 1ì´ë©´ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ / -1ì´ë©´ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ì„ ì˜ë¯¸í•¨.


<br>

### 2) ë³´ì´ëŠ” ê°œìˆ˜ ì œí•œ
posts.ctrl.js ìˆ˜ì •

``` js
 const posts = await Post.find().sort({ _id: -1 }).limit(10).exec();

```
-> `limit()` í•¨ìˆ˜ë¡œ ê°œìˆ˜ë¥¼ ì œí•œí•  ìˆ˜ ìˆìŒ.


<br>

### 3) í˜ì´ì§€ ê¸°ëŠ¥ êµ¬í˜„

- `limit()` í•¨ìˆ˜ì™€ `skip()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨.
-> skip(10)ì´ë©´ ì²˜ìŒ 10ê°œë¥¼ ì œì™¸í•œ ë‹¤ìŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤.
-> ì¦‰, skip í•¨ìˆ˜ì˜ ì¸ìëŠ” ê±´ë„ˆë›¸ ë°ì´í„°ì˜ ê°œìˆ˜ì´ë‹¤.

- skip()ì˜ ì¸ìë¡œ `(page - 1) * 10` ì„ ë„£ì–´ì£¼ë©´ ëœë‹¤.
-> page ê°’ì€ urlì˜ ì¿¼ë¦¬ì—ì„œ ë°›ì•„ì˜¤ë„ë¡ ì„¤ì •. (page ê°’ì´ ì—†ë‹¤ë©´ 1ë¡œ ê¸°ë³¸ê°’)



posts.ctrl.js ìˆ˜ì •

``` js
export const list = async (ctx) => {
  // ğŸ”» page ê°’ì€ queryë¡œ ë°›ì•„ì˜´. (?page=2 ì™€ ê°™ì´) 
  const page = parseInt(ctx.query.page || '1');

  if (page < 1) {
    ctx.status = 400;
    return;
  }

  try {
    const posts = await Post.find()
      .sort({ _id: -1 })
      .limit(10)
    // ğŸ”» í˜„ì¬ 1í˜ì´ì§€ë©´ 0ê°œ ìŠ¤í‚µ, 2í˜ì´ì§€ë©´ 10ê°œ ìŠ¤í‚µ, 3í˜ì´ì§€ë©´ 20ê°œ ìŠ¤í‚µ ...
      .skip((page - 1) * 10)
      .exec();
    
    ctx.body = posts;
  } catch (e) {
    ctx.throw(500, e);
  }
};
```

- ì°¸ê³ ë¡œ, queryëŠ” ë¬¸ìì—´ì´ë¯€ë¡œ ë°˜ë“œì‹œ parseInt()ë¥¼ í•´ì„œ ìˆ«ìí˜•ìœ¼ë¡œ ë°”ê¿”ì¤˜ì•¼ í•¨.


<br>


### 4) ë§ˆì§€ë§‰ í˜ì´ì§€ ë²ˆí˜¸ ì•Œë ¤ì£¼ê¸°
posts.ctrl.js ìˆ˜ì •

``` js
export const list = async (ctx) => {
  const page = parseInt(ctx.query.page || '1');

  if (page < 1) {
    ctx.status = 400;
    return;
  }

  try {
    const posts = await Post.find()
      .sort({ _id: -1 })
      .limit(10)
      .skip((page - 1) * 10)
      .exec();
    
    // ğŸ”» ë§ˆì§€ë§‰ í˜ì´ì§€ ë²ˆí˜¸ ì•Œë ¤ì¤Œ
    const postCount = await Post.countDocuments().exec(); // ë¬¸ì„œ ìˆ˜ ëª‡ê°œì¸ì§€ ê°€ì ¸ì˜´
    ctx.gst('Last-page', Math.ceil(postCount / 10)); // í˜ì´ì§€ ìˆ˜ ì¹´ìš´íŠ¸

    ctx.body = posts;
  } catch (e) {
    ctx.throw(500, e);
  }
};
```

- Math.ceilì€ ì˜¬ë¦¼(+1)ì„ í•˜ëŠ” ê²ƒ.
- ê¸€ì´ 38ê°œë¼ë©´ 38/10 = 3.8 ì´ê³ , í˜ì´ì§€ëŠ” 3.8ì„ ì˜¬ë¦¼í•œ 4ê°œì¼ ê²ƒì„.

#### ğŸ”» HTTP í—¤ë” ì„¤ì •
``` js
ctx.set('Last-page', Math.ceil(postCount / 10));
```
-> Last-page ë¼ëŠ” ì»¤ìŠ¤í…€ í—¤ë”ë¥¼ ì„¤ì •í•¨.
postmanì„ í†µí•´ í™•ì¸ ê°€ëŠ¥.
![](https://velog.velcdn.com/images/thisisyjin/post/ea015369-7896-4ea6-a029-02f13ecca3c3/image.png)
-> í˜„ì¬ ì´ 40ê°œì˜ ê¸€ì´ ìˆìœ¼ë¯€ë¡œ, 4í˜ì´ì§€ê°€ ë§ˆì§€ë§‰ í˜ì´ì§€ì„.


<br>

### 5) ê¸€ ë‚´ìš© ê¸¸ì´ì œí•œ
posts.ctrl.js ìˆ˜ì •

#### toJSON() ì´ìš©

``` js
export const list = async (ctx) => {
  const page = parseInt(ctx.query.page || '1');

  if (page < 1) {
    ctx.status = 400;
    return;
  }

  try {
    const posts = await Post.find()
      .sort({ _id: -1 })
      .limit(10)
      .skip((page - 1) * 10)
      .exec();

    const postCount = await Post.countDocuments().exec(); // ë¬¸ì„œ ìˆ˜ ëª‡ê°œì¸ì§€ ê°€ì ¸ì˜´
    ctx.set('Last-page', Math.ceil(postCount / 10)); // í˜ì´ì§€ ìˆ˜ ì¹´ìš´íŠ¸

    // ğŸ”» map()ìœ¼ë¡œ ìš°ì„  JSON í˜•ì‹ìœ¼ë¡œ ë°°ì—´ì„ ë°”ê¿”ì¤€ í›„ ë³€í˜•í•´ì•¼ í•¨.
    ctx.body = posts
      .map((post) => post.toJSON())
      .map((post) => ({
        ...post,
        body:
          post.body.length < 200 ? post.body : `${post.body.slice(0, 200)}...`,
      }));
  } catch (e) {
    ctx.throw(500, e);
  }
};
```

- find()ë¥¼ í†µí•´ ì¡°íšŒí•œ ë°ì´í„°ëŠ” Mongoose ë¬¸ì„œ ì¸ìŠ¤í„´ìŠ¤ í˜•íƒœì´ë¯€ë¡œ, ë°ì´í„°ë¥¼ ë°”ë¡œ ë³€í™˜í•  ìˆ˜ âŒ
-> `toJSON()` í•¨ìˆ˜ë¡œ JSON í˜•íƒœë¡œ ë°”ê¾¼ ë‹¤ìŒì— ë³€í˜•í•´ì•¼ í•¨.


#### lean() ì´ìš©

ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ, ë°ì´í„° ì¡°íšŒì‹œ `lean()` í•¨ìˆ˜ë¥¼ ì´ìš©í• ìˆ˜ë„ ìˆë‹¤.
`.exec()`ì˜ ì•ì— .lean()ì„ ë„£ì–´ì£¼ë©´ ì²˜ìŒë¶€í„° JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.

``` js
const posts = await Post.find()
      .sort({ _id: -1 })
      .limit(10)
      .skip((page - 1) * 10)
      .lean()
      .exec();

...

ctx.body = posts.map((post) => ({
      ...post,
      body:
        post.body.length < 200 ? post.body : `${post.body.slice(0, 200)}...`,
    }));

```

![](https://velog.velcdn.com/images/thisisyjin/post/324fd0f9-d452-48c7-a40f-f5fcf10496a0/image.png)
-> GET ìš”ì²­ì„ í•´ë³´ë©´ ì´ëŸ°ì‹ìœ¼ë¡œ 200ìë¡œ ì˜ ì œí•œë˜ì–´ ìˆë‹¤.
